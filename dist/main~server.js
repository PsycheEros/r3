exports.ids=[1],exports.modules=[,,,,,,,,,,,,,function(e,t,n){"use strict";n(14),n(2),n(3);var o=n(10),i=n(0),r=n(4),a=n(5),s=n(37),c=n(31),l=n(33),d=n(35),u=n(34),y=n(36),f=n(32),p=n(40),m=n(45),g=n(1),h=n(46),w=n(47),v=E(n(23)),b=E(n(24)),S=E(n(25));function E(e){return e&&e.__esModule?e:{default:e}}function O(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){R(e,t,n[t])})}return e}function R(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const{OPENSHIFT_REDIS_HOST:x,OPENSHIFT_REDIS_PASSWORD:j,OPENSHIFT_REDIS_PORT:M}=process.env,P=n(26).Server(m.app),k=n(27)(P);if(k.engine.generateId=v.default,x){const e=n(28).createClient,t=n(29),o=e(M,x,{auth_pass:j}),i=e(M,x,{return_buffers:!0,auth_pass:j});k.adapter(t({pubClient:o,subClient:i}))}function C(e){return Object.entries(k.of("/").connected).filter(([t,n])=>t===e).map(([e,t])=>t)[0]||null}async function _(e,t){const n=C(t);return n?(await e.findByIds(u.RoomEntity,Object.keys(n.rooms))).map(e=>e.id):[]}async function N(e,t,n){const o=C(n);await new Promise((e,n)=>{o.join(t,t=>{t?n(t):e()})}),await G(e,n),await z(e,t,n);const{nick:i}=await e.findOne(y.SessionEntity,n,{select:["nick"]});await D(t,`${i} has joined the room.`)}async function G(e,t){const n=await _(e,t);k.to(t).emit("joinedRooms",n)}async function I(e,t){const n=(await e.find(u.RoomEntity)).map(u.RoomEntity.toRoom);(t?k.to(t):k).emit("rooms",n)}async function F(e,t,n){const o=C(t);await new Promise((e,t)=>{o.leave(n,n=>{n?t(n):e()})}),await G(e,t);const{nick:i}=await e.findOne(y.SessionEntity,t,{select:["nick"]});await D(n,`${i} has left the room.`)}function D(e,t,n){return k.to(n||t).emit("message",{roomId:t,message:e}),!0}async function z(e,t,n){await U(e,async e=>{const o=await e.findOne(u.RoomEntity,t);if(!o)return;const i=await e.findOne(c.GameEntity,o.gameId,{relations:["gameStates"]});i&&k.to(n||o.id).emit("update",c.GameEntity.toGame(i))})}async function $(e,t,n){D("New game",t);const o=p.ruleSetMap.get(n);return await U(e,async e=>{const n=o.newGame((0,v.default)()),i=await e.create(c.GameEntity,{id:n.gameId,colors:[...n.colors],mask:n.mask.map(e=>e?"1":"0").join(""),size:O({},n.size),ruleSet:n.ruleSet});return await e.save(i),await B(e,n),await e.update(u.RoomEntity,t,{gameId:i.id}),I(e),z(e,t),n})}async function B(e,t){return await U(e,async e=>{await Promise.all(t.gameStates.map(async(n,o)=>{let i=await e.findOne(l.GameStateEntity,{gameId:t.gameId,index:o});i||(i=await e.create(l.GameStateEntity,{gameId:t.gameId,index:o})),i.turn=n.turn,i.data=n.data.map(e=>null==e?"x":String(e)),i.lastMove=O({},n.lastMove),await e.save(i)}))})}const U=(()=>{let e=null;return(t,n)=>((0,S.default)(t),e?n(e):t.transaction(async t=>{e=t;try{return await n(e)}finally{e=null}}))})();(async()=>{try{const{manager:e}=await(0,o.createConnection)(O({},g.connectionOptions,{entities:[c.GameEntity,l.GameStateEntity,d.LoginEntity,u.RoomEntity,y.SessionEntity,f.UserEntity]}));(0,i.interval)(b.default.duration(g.cleanup.rooms.checkSeconds,"s").asMilliseconds()).subscribe(async()=>{!async function(e){await U(e,async e=>{let t=0;await Promise.all((await e.find(u.RoomEntity,{select:["id","expires"]})).map(async n=>{if(0===(await new Promise((e,t)=>{k.in(n.id).clients((n,o)=>{n?t(n):e(o)})})).length)if(n.expires)(0,b.default)(n.expires).isSameOrBefore()&&(console.log(`Deleting room ${n.id}...`),await e.remove(n),++t);else{const t=(0,b.default)().add(g.cleanup.rooms.expireSeconds,"s");console.log(`Queuing room ${n.id} for deletion ${t.fromNow()}...`),n.expires=t.toDate(),await e.save(n)}})),t&&await I(e)})}(e)});let t=0;(0,a.fromNodeEvent)(k,"connection").subscribe(async n=>{console.log(`User connected, ${++t} connected, ${n.id}`);const o=(0,a.fromNodeEvent)(n,"disconnecting").pipe((0,r.take)(1)),l=(0,a.fromNodeEvent)(n,"disconnect").pipe((0,r.take)(1));function d(t,o){const s=new i.Subject;return(0,a.fromNodeEvent)(n,t).pipe((0,r.takeUntil)(l),(0,r.mergeMap)(([t,n])=>(0,i.of)(t).pipe((0,r.mergeMap)(t=>U(e,async e=>o(O({manager:e},t)))),(0,r.tap)({next(e){n(null,null==e?{}:e)},error(e){console.error(e),n(null==e?{}:e.message,null)}}),(0,r.onErrorResumeNext)()))).subscribe(s),s}const m=n.id;await e.save(await e.create(y.SessionEntity,{id:m,nick:"Guest"})),o.subscribe(async()=>{await U(e,async e=>{try{const t=await _(e,m);if(t.length>0){const{nick:n}=await e.findOne(y.SessionEntity,m,{select:["nick"]});await Promise.all(t.map(e=>D(`${n} has disconnected.`,e)))}}finally{e.delete(y.SessionEntity,m)}})}),l.subscribe(async()=>{console.log(`User disconnected, ${--t} connected`)});const g={async help(e){await D("Available commands:\n/?\n/help\n/nick <name>\n/quit\n/who\n",e,m)},async"?"(e){await g.help(e)},async nick(t,n){if(!(0,s.isValidNick)(n))throw new Error("Invalid nick.");let o;await U(e,async e=>{const t=await e.findOne(y.SessionEntity,m),i=await e.count(y.SessionEntity,{nick:n})>0,r=await e.count(f.UserEntity,{nick:n})>0;if(i||r)throw new Error("Nick is already in use.");o=t.nick,t.nick=n,t.userId&&await e.update(f.UserEntity,t.userId,{nick:n}),await e.save(t)}),await D(`${o} is now known as ${n}.`,t)},async quit(t){await F(e,m,t)},async who(t){const n=await new Promise((e,n)=>{k.in(t).clients((t,o)=>{t?n(t):e(o)})}),o=(await e.findByIds(y.SessionEntity,n)).map(e=>e.nick).sort();await D(`Users in room:\n${o.join("\n")}`,t,m)}};d("makeMove",async({roomId:t,position:n})=>{if(!await async function(e,t,n){return await U(e,async e=>{const o=await e.findOne(u.RoomEntity,t),i=await e.findOne(c.GameEntity,o.gameId,{relations:["gameStates"]}),r=p.ruleSetMap.get(i.ruleSet);let a=c.GameEntity.toGame(i);const s=a.gameStates.slice(-1)[0],l=r.makeMove(a,s,n);if(!l)return!1;if(a=O({},a,{gameStates:[...a.gameStates,l]}),await B(e,a),r.isGameOver(a,l)){const e=Array.from({length:r.colors}).map((e,t)=>({color:h.colors[a.colors[t]].displayName,score:r.getScore(a,l,t)}));e.sort((e,t)=>{const n=r.compareScores(e.score,t.score);return 0===n?e.color.localeCompare(t.color):n});const n=e[0].score,o=e.filter(({score:e})=>r.compareScores(e,n));let i;i=1!==o.length?"Draw game.":`${o[0].color} wins.`,await D(`${i}:\n${e.map(({color:e,score:t})=>`${e}: ${t}`).join("\n")}`,t)}return await z(e,t),!0})}(e,t,n))throw new Error("Failed to make move.")}),d("newGame",async({roomId:t,ruleSet:n})=>{const o=await $(e,t,n);if(!o)throw new Error("Failed to create game.");return{game:o}}),d("sendMessage",async({roomId:t,message:n})=>{if(n.startsWith("/"))return void await async function(t,n){const[o,...i]=n.trim().split(/\s+/g);try{if(!g.hasOwnProperty(o))throw new Error("Unknown command.");if(!(await _(e,m)).includes(t))throw new Error("Not in room.");await g[o](t,...i)}catch(e){throw e&&e.message&&await D(e.message,t,m),e}}(t,n.slice(1));const{nick:o}=await e.findOne(y.SessionEntity,m,{select:["nick"]});if(!await function(e,t,n){return k.to(n).emit("message",{roomId:n,user:e,message:t}),!0}(o,n,t))throw new Error("Failed to send message.")}),d("createRoom",async({manager:e,name:t,password:n})=>{const o=await async function(e,t,n,o){if(!(0,s.isValidRoomName)(n))throw new Error("Invalid room name.");return await U(e,async e=>{const i=await e.create(u.RoomEntity,{name:n,passwordHash:await(0,w.hashPassword)(o)});return await e.save(i),await N(e,i.id,t),await $(e,i.id,"standard"),i})}(e,m,t,n);return u.RoomEntity.toRoom(o)}),d("joinRoom",async({manager:e,roomId:t,password:n})=>{const o=await e.findOne(u.RoomEntity,t);if(!o)throw new Error("Failed to join room.");if(o.passwordHash){if(!n)throw new Error("Room requires a password.");if(!await(0,w.checkPassword)(n,o.passwordHash))throw new Error("Incorrect password.")}return e.update(u.RoomEntity,t,{expires:null}),await N(e,t,m),u.RoomEntity.toRoom(o)}),d("leaveRoom",async({manager:e,roomId:t})=>{await F(e,m,t)}),I(e,m)})}catch(e){console.error(e)}})(),P.listen(m.app.get("port"),m.app.get("host"),e=>{if(e)return void console.error(e);const{address:t,port:n}=P.address();console.log(`Process ${process.pid} listening at ${t}:${n}...`)})},,,,,,,,,,,,,,,,,function(e,t,n){"use strict";t.__esModule=!0,t.MetadataField=void 0;var o=n(10),i=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},r=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class a{}t.MetadataField=a,i([(0,o.CreateDateColumn)({select:!1}),r("design:type",Date)],a.prototype,"created",void 0),i([(0,o.UpdateDateColumn)({select:!1}),r("design:type",Date)],a.prototype,"updated",void 0)},function(e,t,n){"use strict";t.__esModule=!0,t.GameEntity=void 0;var o=n(10),i=n(33),r=n(34),a=n(30),s=n(11),c=n(39);function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){d(e,t,n[t])})}return e}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},y=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let f=class{static toGame(e){const t=(0,s.sortBy)(e.gameStates,e=>e.index);return{gameId:e.id,size:l({},e.size),colors:[...e.colors],mask:e.mask.split("").map(e=>"1"===e),ruleSet:e.ruleSet,gameStates:t.map(e=>({index:e.index,turn:e.turn,data:e.data.map(e=>"x"===e?null:parseInt(e,10)),lastMove:null==e.lastMove.x||null==e.lastMove.y?null:l({},e.lastMove)}))}}};t.GameEntity=f,u([(0,o.PrimaryGeneratedColumn)("uuid"),y("design:type",String)],f.prototype,"id",void 0),u([(0,o.Column)(()=>a.MetadataField),y("design:type",a.MetadataField)],f.prototype,"meta",void 0),u([(0,o.Column)("simple-array"),y("design:type",Array)],f.prototype,"colors",void 0),u([(0,o.OneToMany)(()=>i.GameStateEntity,e=>e.game,{cascade:!0}),y("design:type",Array)],f.prototype,"gameStates",void 0),u([(0,o.Column)(()=>c.SizeField),y("design:type",c.SizeField)],f.prototype,"size",void 0),u([(0,o.Column)(),y("design:type",String)],f.prototype,"mask",void 0),u([(0,o.OneToOne)(()=>r.RoomEntity,{nullable:!0}),y("design:type",r.RoomEntity)],f.prototype,"room",void 0),u([(0,o.Column)(),y("design:type",String)],f.prototype,"ruleSet",void 0),t.GameEntity=f=u([(0,o.Entity)("Game")],f)},function(e,t,n){"use strict";t.__esModule=!0,t.UserEntity=void 0;var o=n(10),i=n(35),r=n(36),a=n(30),s=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},c=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let l=class{};t.UserEntity=l,s([(0,o.PrimaryGeneratedColumn)("uuid"),c("design:type",String)],l.prototype,"id",void 0),s([(0,o.Column)(()=>a.MetadataField),c("design:type",a.MetadataField)],l.prototype,"meta",void 0),s([(0,o.Column)({unique:!0}),c("design:type",String)],l.prototype,"nick",void 0),s([(0,o.OneToMany)(()=>r.SessionEntity,e=>e.user),c("design:type",Array)],l.prototype,"sessions",void 0),s([(0,o.OneToOne)(()=>i.LoginEntity,e=>e.user,{cascade:!0}),(0,o.JoinColumn)(),c("design:type",i.LoginEntity)],l.prototype,"login",void 0),t.UserEntity=l=s([(0,o.Entity)("User")],l)},function(e,t,n){"use strict";t.__esModule=!0,t.GameStateEntity=void 0;var o=n(10),i=n(31),r=n(38),a=n(30),s=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},c=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let l=class{};t.GameStateEntity=l,s([(0,o.PrimaryColumn)("uuid"),c("design:type",String)],l.prototype,"gameId",void 0),s([(0,o.PrimaryColumn)({type:"integer"}),c("design:type",Number)],l.prototype,"index",void 0),s([(0,o.Column)(()=>a.MetadataField),c("design:type",a.MetadataField)],l.prototype,"meta",void 0),s([(0,o.ManyToOne)(()=>i.GameEntity,e=>e.gameStates),c("design:type",i.GameEntity)],l.prototype,"game",void 0),s([(0,o.Column)({type:"integer",nullable:!0}),c("design:type",Number)],l.prototype,"turn",void 0),s([(0,o.Column)(()=>r.PointFieldNull),c("design:type",r.PointFieldNull)],l.prototype,"lastMove",void 0),s([(0,o.Column)({type:"simple-array"}),c("design:type",Array)],l.prototype,"data",void 0),t.GameStateEntity=l=s([(0,o.Entity)("GameState")],l)},function(e,t,n){"use strict";t.__esModule=!0,t.RoomEntity=void 0;var o=n(10),i=n(31),r=n(30),a=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},s=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let c=class{static toRoom(e){return{roomId:e.id,gameId:e.gameId,name:e.name,hasPassword:!!e.passwordHash}}};t.RoomEntity=c,a([(0,o.PrimaryGeneratedColumn)("uuid"),s("design:type",String)],c.prototype,"id",void 0),a([(0,o.Column)(()=>r.MetadataField),s("design:type",r.MetadataField)],c.prototype,"meta",void 0),a([(0,o.Column)(),s("design:type",String)],c.prototype,"name",void 0),a([(0,o.Column)({nullable:!0}),s("design:type",Date)],c.prototype,"expires",void 0),a([(0,o.Column)(),s("design:type",String)],c.prototype,"passwordHash",void 0),a([(0,o.Column)("uuid",{nullable:!0}),s("design:type",String)],c.prototype,"gameId",void 0),a([(0,o.OneToOne)(()=>i.GameEntity,{nullable:!0}),(0,o.JoinColumn)(),s("design:type",i.GameEntity)],c.prototype,"game",void 0),t.RoomEntity=c=a([(0,o.Entity)("Room")],c)},function(e,t,n){"use strict";t.__esModule=!0,t.LoginEntity=void 0;var o=n(10),i=n(32),r=n(30),a=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},s=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let c=class{};t.LoginEntity=c,a([(0,o.PrimaryGeneratedColumn)("uuid"),s("design:type",String)],c.prototype,"id",void 0),a([(0,o.Column)(()=>r.MetadataField),s("design:type",r.MetadataField)],c.prototype,"meta",void 0),a([(0,o.Column)(),(0,o.Index)({unique:!0}),s("design:type",String)],c.prototype,"username",void 0),a([(0,o.Column)(),s("design:type",String)],c.prototype,"passwordHash",void 0),a([(0,o.OneToOne)(()=>i.UserEntity,e=>e.login),s("design:type",i.UserEntity)],c.prototype,"user",void 0),a([(0,o.Column)("uuid",{nullable:!0}),s("design:type",String)],c.prototype,"userId",void 0),t.LoginEntity=c=a([(0,o.Entity)("Login")],c)},function(e,t,n){"use strict";t.__esModule=!0,t.SessionEntity=void 0;var o=n(10),i=n(32),r=n(30),a=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},s=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};let c=class{};t.SessionEntity=c,a([(0,o.PrimaryColumn)("uuid"),s("design:type",String)],c.prototype,"id",void 0),a([(0,o.Column)(()=>r.MetadataField),s("design:type",r.MetadataField)],c.prototype,"meta",void 0),a([(0,o.Column)(),s("design:type",String)],c.prototype,"nick",void 0),a([(0,o.ManyToOne)(()=>i.UserEntity,e=>e.sessions),s("design:type",i.UserEntity)],c.prototype,"user",void 0),a([(0,o.Column)("uuid",{nullable:!0}),s("design:type",String)],c.prototype,"userId",void 0),t.SessionEntity=c=a([(0,o.Entity)("Session")],c)},function(e,t,n){"use strict";t.__esModule=!0,t.isValidNick=function(e){return!!e&&!(e.length>o.validation.maxNickLength)&&/^[_a-z][-_a-z0-9]+[_a-z0-9]+/i.test(e)},t.isValidRoomName=function(e){return!(!e||e.length>o.validation.maxRoomNameLength)};var o=n(1)},function(e,t,n){"use strict";t.__esModule=!0,t.PointFieldNull=t.PointField=void 0;var o=n(10),i=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},r=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class a{}t.PointField=a,i([(0,o.Column)({type:"integer"}),r("design:type",Number)],a.prototype,"x",void 0),i([(0,o.Column)({type:"integer"}),r("design:type",Number)],a.prototype,"y",void 0);class s{}t.PointFieldNull=s,i([(0,o.Column)({type:"integer",nullable:!0}),r("design:type",Number)],s.prototype,"x",void 0),i([(0,o.Column)({type:"integer",nullable:!0}),r("design:type",Number)],s.prototype,"y",void 0)},function(e,t,n){"use strict";t.__esModule=!0,t.SizeFieldNull=t.SizeField=void 0;var o=n(10),i=function(e,t,n,o){var i,r=arguments.length,a=r<3?t:null===o?o=Object.getOwnPropertyDescriptor(t,n):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,n,o);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(a=(r<3?i(a):r>3?i(t,n,a):i(t,n))||a);return r>3&&a&&Object.defineProperty(t,n,a),a},r=function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)};class a{}t.SizeField=a,i([(0,o.Column)({type:"integer"}),r("design:type",Number)],a.prototype,"width",void 0),i([(0,o.Column)({type:"integer"}),r("design:type",Number)],a.prototype,"height",void 0);class s{}t.SizeFieldNull=s,i([(0,o.Column)({type:"integer",nullable:!0}),r("design:type",Number)],s.prototype,"width",void 0),i([(0,o.Column)({type:"integer",nullable:!0}),r("design:type",Number)],s.prototype,"height",void 0)},function(e,t,n){"use strict";t.__esModule=!0,t.ruleSetMap=t.ruleSets=t.rulesReversed=t.rulesStandard=void 0;var o=n(41);function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},o=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable}))),o.forEach(function(t){r(e,t,n[t])})}return e}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const a=[{x:0,y:-1},{x:1,y:-1},{x:1,y:0},{x:1,y:1},{x:0,y:1},{x:-1,y:1},{x:-1,y:0},{x:-1,y:-1}];function s(e,t,n){if(!e.boundsCheck(t))return[];const o=e.get(t);if(!o||!o.empty||!o.enabled)return[];function i({x:t,y:o},i){const r=[];for(;;){if(t+=i.x,o+=i.y,!e.boundsCheck({x:t,y:o}))return[];const a=e.get({x:t,y:o});if(!a||a.empty||!a.enabled)return[];if(a.color===n)return r;r.push(a)}}let r=[o];for(const e of a)r=[...r,...i(t,e)];return r.length<=1?[]:r}class c{constructor(){this.name="Standard",this.ruleSet="standard",this.colors=2,this.boardSize=Object.freeze({width:8,height:8})}isValid(e,t,n,i){return s(o.Board.fromGame(e,t),n,i).length>0}compareScores(e,t){return e-t}getValidMoves(e,t,n){const o=[],{size:{width:i,height:r}}=e;for(let a=0;a<i;++a)for(let i=0;i<r;++i){const r={x:a,y:i};this.isValid(e,t,r,n)&&o.push(r)}return o}isGameOver(e,t){const{colors:n}=this;for(let o=0;o<n;++o)if(this.getValidMoves(e,t,o).length>0)return!1;return!0}makeMove(e,t,n){const{turn:r,index:a}=t,c=o.Board.fromGame(e,t),l=s(c,n,r);if(0===l.length)return null;for(const e of l)e.color=r;const d=a+1,u=Object.freeze(i({},n)),y=c.getData(),{colors:f}=this;let p=null;for(let t=0;t<f;++t){const n=(r+1+t)%f;if(this.getValidMoves(e,{turn:n,index:d,data:y,lastMove:u},n).length>0){p=n;break}}return{turn:p,index:d,data:y,lastMove:u}}getScore(e,t,n){const i=o.Board.fromGame(e,t);let r=0;for(const e of i)e&&e.enabled&&e.color===n&&++r;return r}newGame(e){const{boardSize:t}=this,n=new o.Board;n.reset(t),n.get({x:3,y:3}).color=0,n.get({x:4,y:3}).color=1,n.get({x:3,y:4}).color=1,n.get({x:4,y:4}).color=0;const r=[{turn:0,index:0,data:n.getData(),lastMove:null}];return{gameId:e,ruleSet:this.ruleSet,mask:n.getMask(),colors:Object.freeze(["black","white"]),size:Object.freeze(i({},t)),gameStates:Object.freeze(r)}}}const l=new c;t.rulesStandard=l;const d=new class extends c{constructor(){super(...arguments),this.name="Reversed",this.ruleSet="reversed"}compareScores(e,t){return t-e}};t.rulesReversed=d;const u=[l,d];t.ruleSets=u;const y=new Map;t.ruleSetMap=y;for(const e of u)y.set(e.ruleSet,e)},function(e,t,n){"use strict";t.__esModule=!0,t.Board=void 0,n(15),n(12);var o=n(42),i=n(43),r=n(44),a=n(11);class s{constructor(){this.bounds=new i.Bounds(0,0,0,0),this.grid=new o.Grid(0,0)}reset({width:e,height:t}){const n=new o.Grid(e,t),a=64,s=64,c=6,l=6,d=new i.Bounds(.5,.5,1+e*(a+c)+c,1+t*(s+l)+l);for(let o=0;o<e;++o)for(let e=0;e<t;++e){const t={x:o,y:e},d=new i.Bounds(.5+o*(a+c)+c,.5+e*(s+l)+l,.5+a,.5+s);n.set({x:o,y:e},new r.Square(t,d))}Object.assign(this,{grid:n,bounds:d})}get width(){const{grid:{width:e}}=this;return e}get height(){const{grid:{height:e}}=this;return e}get({x:e,y:t}){const{grid:n}=this;return n.get({x:e,y:t})}boundsCheck({x:e,y:t}){const{grid:n}=this;return n.boundsCheck({x:e,y:t})}getData(){return Object.freeze(Array.from(this.grid).map(e=>e.empty?null:e.color))}setData(e){for(const[t,n]of(0,a.zip)(e,Array.from(this.grid)))n.color=t}getGameState(e){return{index:e,data:this.getData()}}getMask(){return Object.freeze(Array.from(this.grid).map(e=>e.enabled))}setMask(e){for(const[t,n]of(0,a.zip)(e,Array.from(this.grid)))n.enabled=t}static fromGame(e,t){const n=new s;return n.reset(e.size),n.setData(t.data),n.setMask(e.mask),n}[Symbol.iterator](){const{grid:e}=this;return e[Symbol.iterator]()}hitTest(e){for(const t of this)if(t.bounds.hitTest(e))return t;return null}}t.Board=s},function(e,t,n){"use strict";function o(e,{x:t,y:n}){if(!Number.isSafeInteger(t)||!Number.isSafeInteger(n))throw new Error(`(${t}, ${n}) is not valid`);if(!e.boundsCheck({x:t,y:n}))throw new Error(`(${t}, ${n}) is out of bounds`)}t.__esModule=!0,t.Grid=void 0,n(12);t.Grid=class{constructor(e,t){this.width=e,this.height=t,this.data=new Map}boundsCheck({x:e,y:t}){const{width:n,height:o}=this;return e>=0&&e<n&&t>=0&&t<o}get({x:e,y:t}){o(this,{x:e,y:t});const n=JSON.stringify({x:e,y:t});return this.data.get(n)}set({x:e,y:t},n){o(this,{x:e,y:t});const i=JSON.stringify({x:e,y:t});this.data.set(i,n)}[Symbol.iterator](){return function*(){const{width:e,height:t}=this;for(let n=0;n<e;++n)for(let e=0;e<t;++e)yield this.get({x:n,y:e})}.call(this)}}},function(e,t,n){"use strict";t.__esModule=!0,t.Bounds=void 0;t.Bounds=class{constructor(e,t,n,o){this.left=e,this.top=t,this.width=n,this.height=o}get bottom(){const{top:e,height:t}=this;return e+t}get right(){const{left:e,width:t}=this;return e+t}get center(){const{left:e,top:t,width:n,height:o}=this;return{x:e+.5*n,y:t+.5*o}}get n(){const{left:e,top:t,width:n}=this;return{x:e+.5*n,y:t}}get ne(){const{left:e,top:t,width:n}=this;return{x:e+n,y:t}}get e(){const{left:e,top:t,width:n,height:o}=this;return{x:e+n,y:t+.5*o}}get se(){const{left:e,top:t,width:n,height:o}=this;return{x:e+n,y:t+o}}get s(){const{left:e,top:t,width:n,height:o}=this;return{x:e+.5*n,y:t+o}}get sw(){const{left:e,top:t,height:n}=this;return{x:e,y:t+n}}get w(){const{left:e,top:t,height:n}=this;return{x:e,y:t+.5*n}}get nw(){const{left:e,top:t}=this;return{x:e,y:t}}hitTest({x:e,y:t}){const{top:n,right:o,bottom:i,left:r}=this;return e>=r&&e<=o&&t>=n&&t<=i}}},function(e,t,n){"use strict";t.__esModule=!0,t.Square=void 0;t.Square=class{constructor(e,t){this.position=e,this.bounds=t,this.enabled=!0,this.color=null}get empty(){return null===this.color}}},function(e,t,n){"use strict";t.__esModule=!0,t.app=void 0;var o=c(n(16)),i=c(n(17)),r=c(n(18)),a=c(n(19)),s=n(1);function c(e){return e&&e.__esModule?e:{default:e}}const l=(0,o.default)();t.app=l;for(const[e,t]of Object.entries(s.appSettings))l.set(e,t);l.use((0,a.default)(),o.default.static(r.default.join(__dirname,"www"))),i.default.extend(l,s.cspPolicy),l.use(n(20).json()),l.get("/health",(e,t)=>{t.writeHead(200),t.end()})},function(e){e.exports={colors:{aqua:{displayName:"Aqua",color:[180,90,55]},black:{displayName:"Black",color:[0,0,0]},blue:{displayName:"Blue",color:[240,90,55]},fuschsia:{displayName:"Fuchsia",color:[300,90,55]},gray:{displayName:"Gray",color:[0,0,55]},green:{displayName:"Green",color:[120,90,55]},orange:{displayName:"Orange",color:[30,90,55]},pink:{displayName:"Pink",color:[330,90,55]},purple:{displayName:"Purple",color:[270,90,55]},red:{displayName:"Red",color:[0,90,55]},white:{displayName:"White",color:[0,0,100]},yellow:{displayName:"Yellow",color:[55,90,55]}}}},function(e,t,n){"use strict";t.__esModule=!0,t.hashPassword=async function(e){if(!e)return"";const t=await(0,i.promisify)(o.genSalt)(null);return await(0,i.promisify)(o.hash)(e,t,null)},t.checkPassword=async function(e,t){if(!e&&!t)return!0;return await(0,i.promisify)(o.compare)(e,t)};var o=n(21),i=n(22)}];
//# sourceMappingURL=main~server.js.map