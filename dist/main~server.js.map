{"version":3,"sources":["webpack:///./src/server/main.ts","webpack:///./node_modules/core-js/modules/_global.js","webpack:///./node_modules/core-js/modules/_wks.js","webpack:///./src/server/metadata.field.ts","webpack:///./node_modules/core-js/modules/_hide.js","webpack:///./node_modules/core-js/modules/_has.js","webpack:///./node_modules/core-js/modules/_fails.js","webpack:///./node_modules/core-js/modules/_descriptors.js","webpack:///./node_modules/core-js/modules/_object-dp.js","webpack:///./node_modules/core-js/modules/_core.js","webpack:///./node_modules/core-js/modules/_shared-key.js","webpack:///./node_modules/core-js/modules/_to-iobject.js","webpack:///./node_modules/core-js/modules/_iterators.js","webpack:///./node_modules/core-js/modules/_library.js","webpack:///./src/server/user.entity.ts","webpack:///./src/server/game.entity.ts","webpack:///./node_modules/core-js/modules/_uid.js","webpack:///./node_modules/core-js/modules/_redefine.js","webpack:///./node_modules/core-js/modules/_is-object.js","webpack:///./node_modules/core-js/modules/_an-object.js","webpack:///./node_modules/core-js/modules/es7.symbol.async-iterator.js","webpack:///./node_modules/core-js/modules/_set-to-string-tag.js","webpack:///./node_modules/core-js/modules/_enum-bug-keys.js","webpack:///./node_modules/core-js/modules/_to-integer.js","webpack:///./node_modules/core-js/modules/_object-keys.js","webpack:///./node_modules/core-js/modules/_shared.js","webpack:///./src/server/session.entity.ts","webpack:///./src/server/login.entity.ts","webpack:///./src/server/room.entity.ts","webpack:///./src/server/game-state.entity.ts","webpack:///./node_modules/core-js/modules/_defined.js","webpack:///./node_modules/core-js/modules/_to-object.js","webpack:///./node_modules/core-js/modules/_a-function.js","webpack:///./node_modules/core-js/modules/_property-desc.js","webpack:///./node_modules/core-js/modules/_dom-create.js","webpack:///./node_modules/core-js/modules/_export.js","webpack:///./src/server/app.ts","webpack:///./src/square.ts","webpack:///./src/bounds.ts","webpack:///./src/grid.ts","webpack:///./node_modules/core-js/modules/_wks-ext.js","webpack:///./node_modules/core-js/modules/_wks-define.js","webpack:///./node_modules/core-js/modules/_object-gpo.js","webpack:///./node_modules/core-js/modules/_html.js","webpack:///./node_modules/core-js/modules/_to-absolute-index.js","webpack:///./node_modules/core-js/modules/_to-length.js","webpack:///./node_modules/core-js/modules/_array-includes.js","webpack:///./node_modules/core-js/modules/_object-keys-internal.js","webpack:///./node_modules/core-js/modules/_object-dps.js","webpack:///./node_modules/core-js/modules/_object-create.js","webpack:///./node_modules/core-js/modules/_iter-create.js","webpack:///./node_modules/core-js/modules/_iter-define.js","webpack:///./node_modules/core-js/modules/_cof.js","webpack:///./node_modules/core-js/modules/_iobject.js","webpack:///./node_modules/core-js/modules/_iter-step.js","webpack:///./node_modules/core-js/modules/_add-to-unscopables.js","webpack:///./node_modules/core-js/modules/es6.array.iterator.js","webpack:///./node_modules/core-js/modules/web.dom.iterable.js","webpack:///./src/board.ts","webpack:///./src/rule-sets.ts","webpack:///./src/server/size.field.ts","webpack:///./src/server/point.field.ts","webpack:///./src/validation.ts","webpack:///./src/server/rxjs.ts","webpack:///./node_modules/core-js/modules/_strict-method.js","webpack:///./node_modules/core-js/modules/_ctx.js","webpack:///./node_modules/core-js/modules/_to-primitive.js","webpack:///./node_modules/core-js/modules/_ie8-dom-define.js","webpack:///./node_modules/core-js/modules/es6.array.sort.js"],"names":["__webpack_require__","_typeorm","_rxjs","_operators","_rxjs2","_validation","_game","_gameState","_login","_room","_session","_user","_ruleSets","_app","_config","_colors","_v","_interopRequireDefault","_moment","_assert","OPENSHIFT_REDIS_HOST","OPENSHIFT_REDIS_PASSWORD","OPENSHIFT_REDIS_PORT","process","env","server","Server","app","io","engine","default","redis","createClient","adapter","pub","auth_pass","sub","return_buffers","pubClient","subClient","getSocket","sessionId","Object","entries","of","connected","filter","id","socket","map","async","getJoinedRoomIds","manager","findByIds","RoomEntity","keys","rooms","room","joinRoom","roomId","Promise","resolve","reject","join","err","flushJoinedRooms","flushUpdate","nick","findOne","SessionEntity","select","statusMessage","roomIds","to","emit","flushRooms","find","toRoom","leaveRoom","leave","message","transaction","game","GameEntity","gameId","relations","toGame","newGame","ruleSet","rules","ruleSetMap","get","gameEntity","create","colors","mask","v","size","_objectSpread","save","saveGameStates","update","all","gameStates","gs","index","gameState","GameStateEntity","turn","data","String","lastMove","m","fn","createConnection","connectionOptions","entities","LoginEntity","UserEntity","interval","duration","cleanup","checkSeconds","asMilliseconds","subscribe","removed","in","clients","length","expires","isSameOrBefore","console","log","remove","add","expireSeconds","fromNow","toDate","cleanupRooms","connections","fromNodeEvent","disconnecting","pipe","take","disconnected","handleCallbackEvent","eventName","result","Subject","takeUntil","mergeMap","value","callback","tap","[object Object]","error","onErrorResumeNext","delete","commands","help","isValidNick","Error","previousNick","session","existingSession","count","existingUser","userId","nicks","s","sort","position","roomEntity","prevGameState","slice","nextGameState","makeMove","isGameOver","scores","Array","from","_","color","displayName","score","getScore","c1","c2","r1","compareScores","localeCompare","bestScore","winners","startsWith","raw","cmd","params","trim","split","hasOwnProperty","includes","ex","command","user","chatMessage","name","password","isValidRoomName","createRoom","listen","address","port","pid","global","module","exports","window","Math","self","Function","__g","store","uid","Symbol","USE_SYMBOL","MetadataField","__decorate","CreateDateColumn","Date","UpdateDateColumn","dP","createDesc","object","key","f","it","call","exec","e","defineProperty","a","anObject","IE8_DOM_DEFINE","toPrimitive","O","P","Attributes","TypeError","core","version","__e","shared","IObject","defined","_metadata","PrimaryGeneratedColumn","Column","unique","OneToMany","OneToOne","login","cascade","JoinColumn","Entity","_lodash","_size","sortBy","parseInt","x","y","SizeField","nullable","px","random","concat","undefined","toString","hide","has","SRC","$toString","TPL","inspectSource","val","safe","isFunction","prototype","this","isObject","def","TAG","tag","stat","configurable","ceil","floor","isNaN","$keys","enumBugKeys","push","mode","copyright","PrimaryColumn","ManyToOne","userEntity","sessions","Index","hasPassword","_point","type","PointFieldNull","bitmap","enumerable","writable","document","is","createElement","redefine","ctx","$export","source","own","out","exp","IS_FORCED","F","IS_GLOBAL","G","IS_STATIC","S","IS_PROTO","IS_BIND","B","target","expProto","U","W","R","_expressCsp","_path","_compression","_express","appSettings","set","use","static","__dirname","extend","cspPolicy","json","req","res","writeHead","end","bounds","enabled","empty","left","top","width","height","bottom","right","center","n","ne","se","sw","w","nw","validate","grid","Number","isSafeInteger","boundsCheck","Map","JSON","stringify","iterator","LIBRARY","wksExt","$Symbol","charAt","toObject","IE_PROTO","ObjectProto","getPrototypeOf","constructor","documentElement","toInteger","max","min","toIObject","toLength","toAbsoluteIndex","IS_INCLUDES","$this","el","fromIndex","arrayIndexOf","names","i","getKeys","defineProperties","Properties","dPs","Empty","createDict","iframeDocument","iframe","style","display","appendChild","src","contentWindow","open","write","lt","close","descriptor","setToStringTag","IteratorPrototype","Constructor","NAME","next","Iterators","$iterCreate","ITERATOR","BUGGY","returnThis","Base","DEFAULT","IS_SET","FORCED","methods","getMethod","kind","proto","DEF_VALUES","VALUES_BUG","$native","$default","$entries","$anyNative","values","cof","propertyIsEnumerable","done","UNSCOPABLES","ArrayProto","addToUnscopables","step","iterated","_t","_i","_k","Arguments","$iterators","wks","TO_STRING_TAG","ArrayValues","DOMIterables","CSSRuleList","CSSStyleDeclaration","CSSValueList","ClientRectList","DOMRectList","DOMStringList","DOMTokenList","DataTransferItemList","FileList","HTMLAllCollection","HTMLCollection","HTMLFormElement","HTMLSelectElement","MediaList","MimeTypeArray","NamedNodeMap","NodeList","PaintRequestList","Plugin","PluginArray","SVGLengthList","SVGNumberList","SVGPathSegList","SVGPointList","SVGStringList","SVGTransformList","SourceBufferList","StyleSheetList","TextTrackCueList","TextTrackList","TouchList","collections","explicit","Collection","_bounds","_square","Board","Bounds","_grid","Grid","squareSize","gutterSize","Square","assign","freeze","sq","square","zip","getData","board","reset","setData","setMask","pt","hitTest","directions","getAffectedSquares","direction","delta","squares","RulesStandard","boardSize","_board","fromGame","score1","score2","points","point","isValid","getValidMoves","prevTurn","prevIndex","t","getMask","rulesStandard","rulesReversed","ruleSets","SizeFieldNull","PointField","validation","maxNickLength","test","roomName","maxRoomNameLength","event","fromEventPattern","addListener","removeListener","fails","method","arg","aFunction","that","b","c","apply","arguments","valueOf","$sort","comparefn"],"mappings":"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","file":"main~server.js","sourcesContent":["import './error-handler';\r\nimport './polyfills';\r\n\r\nimport { createConnection, EntityManager, DeepPartial } from 'typeorm';\r\nimport { Subject, interval, of } from 'rxjs';\r\nimport { onErrorResumeNext, mergeMap, take, tap, takeUntil } from 'rxjs/operators';\r\nimport { fromNodeEvent } from './rxjs';\r\nimport { isValidNick, isValidRoomName } from 'src/validation';\r\nimport { GameEntity } from './game.entity';\r\nimport { GameStateEntity } from './game-state.entity';\r\nimport { LoginEntity } from './login.entity';\r\nimport { RoomEntity } from './room.entity';\r\nimport { SessionEntity } from './session.entity';\r\nimport { UserEntity } from './user.entity';\r\nimport { ruleSetMap } from 'src/rule-sets';\r\nimport { app } from './app';\r\nimport { connectionOptions, cleanup as cleanupConfig } from 'data/config.yaml';\r\nimport { colors } from 'data/colors.yaml';\r\nimport uuid from 'uuid/v4';\r\nimport moment from 'moment';\r\nimport assert from 'assert';\r\n\r\nconst { OPENSHIFT_REDIS_HOST,\r\n\t\tOPENSHIFT_REDIS_PASSWORD,\r\n\t\tOPENSHIFT_REDIS_PORT\r\n} = process.env;\r\n\r\ntype CallbackEvent<T = {}, U = {}> = [ T, ( error: Error|null, value: U|null ) => void ];\r\n\r\nconst server = require( 'http' ).Server( app ),\r\n\tio = require( 'socket.io' )( server ) as SocketIO.Server & NodeJS.EventEmitter;\r\n\r\nio.engine[ 'generateId' ] = uuid;\r\n\r\nif( OPENSHIFT_REDIS_HOST ) {\r\n\tconst redis = require( 'redis' ).createClient,\r\n\t\tadapter = require( 'socket.io-redis' ),\r\n\t\tpub = redis( OPENSHIFT_REDIS_PORT, OPENSHIFT_REDIS_HOST, { auth_pass: OPENSHIFT_REDIS_PASSWORD } ),\r\n\t\tsub = redis( OPENSHIFT_REDIS_PORT, OPENSHIFT_REDIS_HOST, { return_buffers: true, auth_pass: OPENSHIFT_REDIS_PASSWORD } );\r\n\r\n\tio.adapter( adapter( { pubClient: pub, subClient: sub } ) );\r\n}\r\n\r\nfunction getSocket( sessionId: string ) {\r\n\treturn Object.entries( io.of( '/' ).connected )\r\n\t.filter( ( [ id, socket ] ) => id === sessionId )\r\n\t.map( ( [ id, socket ] ) => socket )[ 0 ]\r\n\t|| null;\r\n}\r\n\r\nasync function getJoinedRoomIds( manager: EntityManager, sessionId: string ) {\r\n\tconst socket = getSocket( sessionId );\r\n\tif( !socket ) return [];\r\n\tconst rooms = await manager.findByIds( RoomEntity, Object.keys( socket.rooms ) );\r\n\treturn rooms.map( room => room.id );\r\n}\r\n\r\nasync function joinRoom( manager: EntityManager, roomId: string, sessionId: string ) {\r\n\tconst socket = getSocket( sessionId );\r\n\tawait new Promise( ( resolve, reject ) => {\r\n\t\tsocket.join( roomId, err => {\r\n\t\t\tif( err ) { reject( err ); }\r\n\t\t\telse { resolve(); }\r\n\t\t} );\r\n\t} );\r\n\tawait flushJoinedRooms( manager, sessionId );\r\n\tawait flushUpdate( manager, roomId, sessionId );\r\n\tconst { nick } = await manager.findOne( SessionEntity, sessionId, { select: [ 'nick' ] } );\r\n\tawait statusMessage( roomId, `${nick} has joined the room.` );\r\n}\r\n\r\nasync function flushJoinedRooms( manager: EntityManager, sessionId: string ) {\r\n\tconst roomIds = await getJoinedRoomIds( manager, sessionId );\r\n\tio.to( sessionId ).emit( 'joinedRooms', roomIds );\r\n}\r\n\r\nasync function flushRooms( manager: EntityManager, sessionId?: string ) {\r\n\tconst rooms = ( await manager.find( RoomEntity ) ).map( RoomEntity.toRoom );\r\n\tconst emitter = sessionId ? io.to( sessionId ) : io;\r\n\temitter.emit( 'rooms', rooms );\r\n}\r\n\r\nasync function leaveRoom( manager: EntityManager, sessionId: string, roomId: string ) {\r\n\tconst socket = getSocket( sessionId );\r\n\tawait new Promise( ( resolve, reject ) => {\r\n\t\tsocket.leave( roomId, err => {\r\n\t\t\tif( err ) {\r\n\t\t\t\treject( err );\r\n\t\t\t} else {\r\n\t\t\t\tresolve();\r\n\t\t\t}\r\n\t\t} );\r\n\t} );\r\n\tawait flushJoinedRooms( manager, sessionId );\r\n\tconst { nick } = await manager.findOne( SessionEntity, sessionId, { select: [ 'nick' ] } );\r\n\tawait statusMessage( roomId, `${nick} has left the room.` );\r\n}\r\n\r\nfunction statusMessage( message: string, roomId: string, sessionId?: string ) {\r\n\tio.to( sessionId || roomId ).emit( 'message', { roomId, message } );\r\n\treturn true;\r\n}\r\n\r\nfunction chatMessage( user: string, message: string, roomId: string ) {\r\n\tio.to( roomId ).emit( 'message', { roomId, user, message } );\r\n\treturn true;\r\n}\r\n\r\nasync function flushUpdate( manager: EntityManager, roomId: string, sessionId?: string ) {\r\n\tawait transaction( manager, async manager => {\r\n\t\tconst room = await manager.findOne( RoomEntity, roomId);\r\n\t\tif( !room ) return;\r\n\t\tconst game = await manager.findOne( GameEntity, room.gameId, { relations: [ 'gameStates' ] } );\r\n\t\tif( !game ) return;\r\n\t\tio.to( sessionId || room.id ).emit( 'update', GameEntity.toGame( game ) );\r\n\t} );\r\n}\r\n\r\nasync function cleanupRooms( manager: EntityManager ) {\r\n\tawait transaction( manager, async manager => {\r\n\t\tlet removed = 0;\r\n\t\tawait Promise.all(\r\n\t\t\t( await manager.find( RoomEntity, { select: [ 'id', 'expires' ] } ) )\r\n\t\t\t.map( async room => {\r\n\t\t\t\tconst clients = await new Promise<string[]>( ( resolve, reject ) => {\r\n\t\t\t\t\tio.in( room.id ).clients( ( err, clients ) => {\r\n\t\t\t\t\t\tif( err ) reject( err );\r\n\t\t\t\t\t\telse resolve( clients );\r\n\t\t\t\t\t} );\r\n\t\t\t\t} );\r\n\t\t\t\tif( clients.length === 0 ) {\r\n\t\t\t\t\tif( room.expires ) {\r\n\t\t\t\t\t\tif( moment( room.expires ).isSameOrBefore() ) {\r\n\t\t\t\t\t\t\tconsole.log( `Deleting room ${room.id}...` );\r\n\t\t\t\t\t\t\tawait manager.remove( room );\r\n\t\t\t\t\t\t\t++removed;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconst expires = moment().add( cleanupConfig.rooms.expireSeconds, 's' );\r\n\t\t\t\t\t\tconsole.log( `Queuing room ${room.id} for deletion ${expires.fromNow()}...` );\r\n\t\t\t\t\t\troom.expires = expires.toDate();\r\n\t\t\t\t\t\tawait manager.save( room );\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} )\r\n\t\t);\r\n\t\tif( removed ) await flushRooms( manager );\r\n\t} );\r\n}\r\n\r\nasync function newGame( manager: EntityManager, roomId: string, ruleSet: RuleSet ) {\r\n\tstatusMessage( 'New game', roomId );\r\n\tconst rules = ruleSetMap.get( ruleSet );\r\n\treturn await transaction( manager, async manager => {\r\n\t\tconst game = rules.newGame( uuid() );\r\n\t\tconst gameEntity = await manager.create( GameEntity, {\r\n\t\t\tid: game.gameId,\r\n\t\t\tcolors: [ ...game.colors ],\r\n\t\t\tmask: game.mask.map( v => v ? '1' : '0' ).join( '' ),\r\n\t\t\tsize: { ...game.size },\r\n\t\t\truleSet: game.ruleSet\r\n\t\t} );\r\n\t\tawait manager.save( gameEntity );\r\n\t\tawait saveGameStates( manager, game );\r\n\t\tawait manager.update( RoomEntity, roomId, { gameId: gameEntity.id } );\r\n\t\tflushRooms( manager );\r\n\t\tflushUpdate( manager, roomId );\r\n\t\treturn game;\r\n\t} );\r\n}\r\n\r\nasync function saveGameStates( manager: EntityManager, game: Game ) {\r\n\treturn await transaction( manager, async manager => {\r\n\t\tawait Promise.all(\r\n\t\t\tgame.gameStates.map( async ( gs, index ) => {\r\n\t\t\t\tlet gameState = await manager.findOne( GameStateEntity, { gameId: game.gameId, index } );\r\n\t\t\t\tif( !gameState ) gameState = await manager.create( GameStateEntity, { gameId: game.gameId, index } );\r\n\t\t\t\tgameState.turn = gs.turn;\r\n\t\t\t\tgameState.data = gs.data.map( v => ( v == null ) ? 'x' : String(v) );\r\n\t\t\t\tgameState.lastMove = { ...gs.lastMove };\r\n\t\t\t\tawait manager.save( gameState );\r\n\t\t\t} )\r\n\t\t);\r\n\t} );\r\n}\r\n\r\nconst transaction = ( () => {\r\n\tlet m: EntityManager = null;\r\n\treturn ( <T>( manager: EntityManager, fn: ( manager: EntityManager ) => Promise<T> ) => {\r\n\t\tassert( manager );\r\n\t\tif( m ) {\r\n\t\t\treturn fn( m );\r\n\t\t} else {\r\n\t\t\treturn manager.transaction<T>( async manager => {\r\n\t\t\t\tm = manager;\r\n\t\t\t\ttry {\r\n\t\t\t\t\treturn await fn( m );\r\n\t\t\t\t} finally {\r\n\t\t\t\t\tm = null;\r\n\t\t\t\t}\r\n\t\t\t} );\r\n\t\t}\r\n\t} );\r\n} )();\r\n\r\nasync function createRoom( manager: EntityManager, sessionId: string, name: string, password: string ) {\r\n\tif( !isValidRoomName( name ) ) throw new Error( 'Invalid room name.' );\r\n\treturn await transaction( manager, async manager => {\r\n\t\tconst roomEntity =\r\n\t\t\tawait manager.create( RoomEntity, {\r\n\t\t\t\tname,\r\n\t\t\t\tpassword\r\n\t\t\t} );\r\n\t\tawait manager.save( roomEntity );\r\n\t\tawait joinRoom( manager, roomEntity.id, sessionId );\r\n\t\tawait newGame( manager, roomEntity.id, RuleSet.standard );\r\n\t\treturn roomEntity;\r\n\t} );\r\n}\r\n\r\nasync function makeMove( manager: EntityManager, roomId: string, position: Point ) {\r\n\treturn await transaction( manager, async manager => {\r\n\t\tconst roomEntity = await manager.findOne( RoomEntity, roomId );\r\n\t\tconst gameEntity = await manager.findOne( GameEntity, roomEntity.gameId, { relations: [ 'gameStates' ] } );\r\n\t\tconst rules = ruleSetMap.get( gameEntity.ruleSet );\r\n\t\tlet game = GameEntity.toGame( gameEntity );\r\n\t\tconst prevGameState = game.gameStates.slice( -1 )[ 0 ];\r\n\t\tconst nextGameState = rules.makeMove( game, prevGameState, position );\r\n\t\tif( !nextGameState ) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t\tgame = {\r\n\t\t\t...game,\r\n\t\t\tgameStates: [ ...game.gameStates, nextGameState ]\r\n\t\t};\r\n\t\tawait saveGameStates( manager, game );\r\n\t\tif( rules.isGameOver( game, nextGameState ) ) {\r\n\t\t\tconst scores =\r\n\t\t\tArray.from( { length: rules.colors } )\r\n\t\t\t.map( ( _, color ) => ( {\r\n\t\t\t\tcolor: colors[ game.colors[ color ] ].displayName,\r\n\t\t\t\tscore: rules.getScore( game, nextGameState, color )\r\n\t\t\t} ) );\r\n\t\t\tscores.sort( ( c1, c2 ) => {\r\n\t\t\t\tconst r1 = rules.compareScores( c1.score, c2.score );\r\n\t\t\t\treturn r1 === 0 ? c1.color.localeCompare( c2.color ) : r1;\r\n\t\t\t} );\r\n\t\t\tconst bestScore = scores[ 0 ].score;\r\n\t\t\tconst winners = scores.filter( ( { score } ) => rules.compareScores( score, bestScore ) );\r\n\t\t\tlet message: string;\r\n\t\t\tif( winners.length !== 1 ) {\r\n\t\t\t\tmessage = 'Draw game.';\r\n\t\t\t} else {\r\n\t\t\t\tmessage = `${winners[ 0 ].color} wins.`;\r\n\t\t\t}\r\n\t\t\tawait statusMessage( `${message}:\\n${scores.map(({color, score})=>`${color}: ${score}`).join('\\n')}`, roomId );\r\n\t\t}\r\n\t\tawait flushUpdate( manager, roomId );\r\n\t\treturn true;\r\n\t} );\r\n}\r\n\r\n( async () => {\r\n\ttry {\r\n\t\tconst { manager } = await createConnection( {\r\n\t\t\t...connectionOptions,\r\n\t\t\tentities: [ GameEntity, GameStateEntity, LoginEntity, RoomEntity, SessionEntity, UserEntity ]\r\n\t\t} );\r\n\r\n\t\tinterval( moment.duration( cleanupConfig.rooms.checkSeconds, 's' ).asMilliseconds() )\r\n\t\t.subscribe( async () => {\r\n\t\t\tcleanupRooms( manager );\r\n\t\t} );\r\n\r\n\t\tlet connections = 0;\r\n\r\n\t\tfromNodeEvent<SocketIO.Socket>( io, 'connection' )\r\n\t\t.subscribe( async socket => {\r\n\t\t\tconsole.log( `User connected, ${++connections} connected, ${socket.id}` );\r\n\r\n\t\t\tconst disconnecting = fromNodeEvent( socket, 'disconnecting' ).pipe( take( 1 ) );\r\n\t\t\tconst disconnected = fromNodeEvent( socket, 'disconnect' ).pipe( take( 1 ) );\r\n\r\n\t\t\tfunction handleCallbackEvent<T extends object = {}, U = {}>( eventName: string, fn: ( value: T & { manager: EntityManager } ) => PromiseLike<U|void> ) {\r\n\t\t\t\tconst result = new Subject<U>();\r\n\t\t\t\tfromNodeEvent<CallbackEvent<T, U>>( socket, eventName )\r\n\t\t\t\t.pipe(\r\n\t\t\t\t\ttakeUntil( disconnected ),\r\n\t\t\t\t\tmergeMap<CallbackEvent<T, U>, {}>( ( [ value, callback ] ) =>\r\n\t\t\t\t\t\tof( value )\r\n\t\t\t\t\t\t.pipe(\r\n\t\t\t\t\t\t\tmergeMap( value => transaction( manager, async manager => fn( { manager, ...( value as any ) } ) ) ),\r\n\t\t\t\t\t\t\ttap( {\r\n\t\t\t\t\t\t\t\tnext( value ) {\r\n\t\t\t\t\t\t\t\t\tcallback( null, ( value == null ) ? {} as any : value );\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\terror( err ) {\r\n\t\t\t\t\t\t\t\t\tconsole.error( err );\r\n\t\t\t\t\t\t\t\t\tcallback( ( err == null ) ? {} : err.message, null );\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t} ),\r\n\t\t\t\t\t\t\tonErrorResumeNext()\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t),\r\n\t\t\t\t)\r\n\t\t\t\t.subscribe( result );\r\n\t\t\t\treturn result;\r\n\t\t\t}\r\n\r\n\t\t\tconst sessionId = socket.id;\r\n\t\t\tawait manager.save(\r\n\t\t\t\tawait manager.create( SessionEntity, { id: sessionId, nick: 'Guest' } )\r\n\t\t\t);\r\n\r\n\t\t\tdisconnecting.subscribe( async () => {\r\n\t\t\t\tawait transaction( manager, async manager => {\r\n\t\t\t\t\ttry {\r\n\t\t\t\t\t\tconst roomIds = await getJoinedRoomIds( manager, sessionId );\r\n\t\t\t\t\t\tif( roomIds.length > 0 ) {\r\n\t\t\t\t\t\t\tconst { nick } = await manager.findOne( SessionEntity, sessionId, { select: [ 'nick' ] } );\r\n\t\t\t\t\t\t\tawait Promise.all(\r\n\t\t\t\t\t\t\t\troomIds.map( roomId => statusMessage( `${nick} has disconnected.`, roomId ) )\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} finally {\r\n\t\t\t\t\t\tmanager.delete( SessionEntity, sessionId );\r\n\t\t\t\t\t}\r\n\t\t\t\t} );\r\n\t\t\t} );\r\n\r\n\t\t\tdisconnected.subscribe( async () => {\r\n\t\t\t\tconsole.log( `User disconnected, ${--connections} connected` );\r\n\t\t\t} );\r\n\r\n\r\n\t\t\tconst commands = {\r\n\t\t\t\tasync help( roomId: string ) {\r\n\t\t\t\t\tawait statusMessage( `Available commands:\r\n/?\r\n/help\r\n/nick <name>\r\n/quit\r\n/who\r\n`, roomId, sessionId );\r\n\t\t\t\t},\r\n\t\t\t\tasync '?'( roomId: string ) {\r\n\t\t\t\t\tawait commands.help( roomId );\r\n\t\t\t\t},\r\n\t\t\t\tasync nick( roomId: string, nick: string ) {\r\n\t\t\t\t\tif( !isValidNick( nick ) ) throw new Error( 'Invalid nick.' );\r\n\r\n\t\t\t\t\tlet previousNick: string;\r\n\t\t\t\t\tawait transaction( manager, async manager => {\r\n\t\t\t\t\t\tconst session = await manager.findOne( SessionEntity, sessionId );\r\n\t\t\t\t\t\tconst existingSession = ( await manager.count( SessionEntity, { nick } ) ) > 0;\r\n\t\t\t\t\t\tconst existingUser = ( await manager.count( UserEntity, { nick } ) ) > 0;\r\n\t\t\t\t\t\tif( existingSession || existingUser ) {\r\n\t\t\t\t\t\t\tthrow new Error( 'Nick is already in use.' );\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tpreviousNick = session.nick;\r\n\t\t\t\t\t\tsession.nick = nick;\r\n\t\t\t\t\t\tif( session.userId ) {\r\n\t\t\t\t\t\t\tawait manager.update( UserEntity, session.userId, { nick } );\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tawait manager.save( session );\r\n\t\t\t\t\t} );\r\n\r\n\t\t\t\t\tawait statusMessage( `${previousNick} is now known as ${nick}.`, roomId );\r\n\t\t\t\t},\r\n\t\t\t\tasync quit( roomId: string ) {\r\n\t\t\t\t\tawait leaveRoom( manager, sessionId, roomId );\r\n\t\t\t\t},\r\n\t\t\t\tasync who( roomId: string ) {\r\n\t\t\t\t\tconst clients = await new Promise<string[]>( ( resolve, reject ) => {\r\n\t\t\t\t\t\tio.in( roomId ).clients( ( err, clients ) => {\r\n\t\t\t\t\t\t\tif( err ) reject( err );\r\n\t\t\t\t\t\t\telse resolve( clients );\r\n\t\t\t\t\t\t} );\r\n\t\t\t\t\t} );\r\n\t\t\t\t\tconst sessions = await manager.findByIds( SessionEntity, clients );\r\n\t\t\t\t\tconst nicks = sessions.map( s => s.nick ).sort();\r\n\t\t\t\t\tawait statusMessage( `Users in room:\\n${nicks.join('\\n')}`, roomId, sessionId );\r\n\t\t\t\t}\r\n\t\t\t};\r\n\r\n\t\t\tasync function command( roomId: string, raw: string ) {\r\n\t\t\t\tconst [ cmd, ...params ] = raw.trim().split( /\\s+/g );\r\n\t\t\t\ttry {\r\n\t\t\t\t\tif( !commands.hasOwnProperty( cmd ) ) throw new Error( 'Unknown command.' );\r\n\t\t\t\t\tconst joinedRoomIds = await getJoinedRoomIds( manager, sessionId );\r\n\t\t\t\t\tif( !joinedRoomIds.includes( roomId ) ) throw new Error( 'Not in room.' );\r\n\t\t\t\t\tawait commands[ cmd ]( roomId, ...params );\r\n\t\t\t\t} catch( ex ) {\r\n\t\t\t\t\tif( ex && ex.message ) {\r\n\t\t\t\t\t\tawait statusMessage( ex.message, roomId, sessionId );\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthrow ex;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\thandleCallbackEvent<{ roomId: string; position: Point; }>( 'makeMove', async ( { roomId, position } ) => {\r\n\t\t\t\tif( !await makeMove( manager, roomId, position ) ) throw new Error( 'Failed to make move.' );\r\n\t\t\t} );\r\n\r\n\t\t\thandleCallbackEvent<{ roomId: string; ruleSet: RuleSet }>( 'newGame', async ( { roomId, ruleSet } ) => {\r\n\t\t\t\tconst game = await newGame( manager, roomId, ruleSet );\r\n\t\t\t\tif( !game ) throw new Error( 'Failed to create game.' );\r\n\t\t\t\treturn { game };\r\n\t\t\t} );\r\n\r\n\t\t\thandleCallbackEvent<{ roomId: string; message: string; }>( 'sendMessage', async ( { roomId, message } ) => {\r\n\t\t\t\tif( message.startsWith( '/' ) ) {\r\n\t\t\t\t\tawait command( roomId, message.slice( 1 ) );\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tconst { nick } = await manager.findOne( SessionEntity, sessionId, { select: [ 'nick' ] } );\r\n\t\t\t\tif( !await chatMessage( nick, message, roomId ) ) throw new Error( 'Failed to send message.' );\r\n\t\t\t} );\r\n\r\n\t\t\thandleCallbackEvent<{ name: string; password: string; }>( 'createRoom', async ( { manager, name, password } ) => {\r\n\t\t\t\tconst roomEntity = await createRoom( manager, sessionId, name, password );\r\n\t\t\t\treturn RoomEntity.toRoom( roomEntity );\r\n\t\t\t} );\r\n\r\n\t\t\thandleCallbackEvent<{ roomId: string; password: string; }>( 'joinRoom', async ( { manager, roomId, password } ) => {\r\n\t\t\t\tconst roomEntity = await manager.findOne( RoomEntity, roomId );\r\n\t\t\t\tif( !roomEntity ) throw new Error( 'Failed to join room.' );\r\n\t\t\t\tif( roomEntity.password ) {\r\n\t\t\t\t\tif( !password ) throw new Error( 'Room requires a password.' );\r\n\t\t\t\t\t// TODO: hash\r\n\t\t\t\t\tif( roomEntity.password !== password ) throw new Error( 'Incorrect password.' );\r\n\t\t\t\t}\r\n\t\t\t\tmanager.update( RoomEntity, roomId, { expires: null } );\r\n\t\t\t\tawait joinRoom( manager, roomId, sessionId );\r\n\t\t\t\treturn RoomEntity.toRoom( roomEntity );\r\n\t\t\t} );\r\n\r\n\t\t\thandleCallbackEvent<{ roomId: string; }>( 'leaveRoom', async ( { manager, roomId } ) => {\r\n\t\t\t\tawait leaveRoom( manager, sessionId, roomId );\r\n\t\t\t} );\r\n\r\n\t\t\tflushRooms( manager, sessionId );\r\n\t\t} );\r\n\t} catch( ex ) {\r\n\t\tconsole.error( ex );\r\n\t}\r\n} )();\r\n\r\nserver.listen( app.get( 'port' ), app.get( 'host' ), err => {\r\n\tif( err ) {\r\n\t\tconsole.error( err );\r\n\t\treturn;\r\n\t}\r\n\tconst { address, port } = server.address();\r\n\tconsole.log( `Process ${process.pid} listening at ${address}:${port}...` );\r\n} );\r\n","// https://github.com/zloirock/core-js/issues/86#issuecomment-115759028\nvar global = module.exports = typeof window != 'undefined' && window.Math == Math\n  ? window : typeof self != 'undefined' && self.Math == Math ? self\n  // eslint-disable-next-line no-new-func\n  : Function('return this')();\nif (typeof __g == 'number') __g = global; // eslint-disable-line no-undef\n","var store = require('./_shared')('wks');\nvar uid = require('./_uid');\nvar Symbol = require('./_global').Symbol;\nvar USE_SYMBOL = typeof Symbol == 'function';\n\nvar $exports = module.exports = function (name) {\n  return store[name] || (store[name] =\n    USE_SYMBOL && Symbol[name] || (USE_SYMBOL ? Symbol : uid)('Symbol.' + name));\n};\n\n$exports.store = store;\n","import { CreateDateColumn, UpdateDateColumn } from 'typeorm';\r\n\r\nexport class MetadataField {\r\n\t@CreateDateColumn( { select: false } )\r\n\tpublic created: Date;\r\n\r\n\t@UpdateDateColumn( { select: false } )\r\n\tpublic updated: Date;\r\n}\r\n","var dP = require('./_object-dp');\nvar createDesc = require('./_property-desc');\nmodule.exports = require('./_descriptors') ? function (object, key, value) {\n  return dP.f(object, key, createDesc(1, value));\n} : function (object, key, value) {\n  object[key] = value;\n  return object;\n};\n","var hasOwnProperty = {}.hasOwnProperty;\nmodule.exports = function (it, key) {\n  return hasOwnProperty.call(it, key);\n};\n","module.exports = function (exec) {\n  try {\n    return !!exec();\n  } catch (e) {\n    return true;\n  }\n};\n","// Thank's IE8 for his funny defineProperty\nmodule.exports = !require('./_fails')(function () {\n  return Object.defineProperty({}, 'a', { get: function () { return 7; } }).a != 7;\n});\n","var anObject = require('./_an-object');\nvar IE8_DOM_DEFINE = require('./_ie8-dom-define');\nvar toPrimitive = require('./_to-primitive');\nvar dP = Object.defineProperty;\n\nexports.f = require('./_descriptors') ? Object.defineProperty : function defineProperty(O, P, Attributes) {\n  anObject(O);\n  P = toPrimitive(P, true);\n  anObject(Attributes);\n  if (IE8_DOM_DEFINE) try {\n    return dP(O, P, Attributes);\n  } catch (e) { /* empty */ }\n  if ('get' in Attributes || 'set' in Attributes) throw TypeError('Accessors not supported!');\n  if ('value' in Attributes) O[P] = Attributes.value;\n  return O;\n};\n","var core = module.exports = { version: '2.5.7' };\nif (typeof __e == 'number') __e = core; // eslint-disable-line no-undef\n","var shared = require('./_shared')('keys');\nvar uid = require('./_uid');\nmodule.exports = function (key) {\n  return shared[key] || (shared[key] = uid(key));\n};\n","// to indexed object, toObject with fallback for non-array-like ES3 strings\nvar IObject = require('./_iobject');\nvar defined = require('./_defined');\nmodule.exports = function (it) {\n  return IObject(defined(it));\n};\n","module.exports = {};\n","module.exports = false;\n","import { Entity, Column, PrimaryGeneratedColumn, OneToMany, OneToOne, JoinColumn, CreateDateColumn } from 'typeorm';\r\nimport { LoginEntity } from './login.entity';\r\nimport { SessionEntity } from './session.entity';\r\nimport { MetadataField } from 'server/metadata.field';\r\n\r\n@Entity( 'User' )\r\nexport class UserEntity {\r\n\t@PrimaryGeneratedColumn( 'uuid' )\r\n\tpublic id: string;\r\n\r\n\t@Column( () => MetadataField )\r\n\tpublic meta: MetadataField;\r\n\r\n\t@Column( { unique: true } )\r\n\tpublic nick: string;\r\n\r\n\t@OneToMany( () => SessionEntity, session => session.user )\r\n\tpublic sessions: SessionEntity[];\r\n\r\n\t@OneToOne( () => LoginEntity, login => login.user, {\r\n\t\tcascade: true\r\n\t} )\r\n\t@JoinColumn()\r\n\tpublic login: LoginEntity;\r\n}\r\n","import { Entity, PrimaryGeneratedColumn, OneToOne, OneToMany, Column, CreateDateColumn, UpdateDateColumn } from 'typeorm';\r\nimport { GameStateEntity } from './game-state.entity';\r\nimport { RoomEntity } from './room.entity';\r\nimport { MetadataField } from './metadata.field';\r\nimport { sortBy } from 'lodash';\r\nimport { SizeField } from 'server/size.field';\r\n\r\n@Entity( 'Game' )\r\nexport class GameEntity {\r\n\t@PrimaryGeneratedColumn( 'uuid' )\r\n\tpublic id: string;\r\n\r\n\t@Column( () => MetadataField )\r\n\tpublic meta: MetadataField;\r\n\r\n\t@Column( 'simple-array' )\r\n\tpublic colors: string[];\r\n\r\n\t@OneToMany( () => GameStateEntity, gameState => gameState.game, {\r\n\t\tcascade: true\r\n\t} )\r\n\tpublic gameStates: GameStateEntity[];\r\n\r\n\t@Column( () => SizeField )\r\n\tpublic size: SizeField;\r\n\r\n\t@Column()\r\n\tpublic mask: string;\r\n\r\n\t@OneToOne( () => RoomEntity, { nullable: true } )\r\n\tpublic room: RoomEntity;\r\n\r\n\t@Column()\r\n\tpublic ruleSet: RuleSet;\r\n\r\n\tstatic toGame( gameEntity: GameEntity ): Game {\r\n\t\tconst gameStates = sortBy( gameEntity.gameStates, gs => gs.index );\r\n\t\treturn {\r\n\t\t\tgameId: gameEntity.id,\r\n\t\t\tsize: { ...gameEntity.size },\r\n\t\t\tcolors: [ ...gameEntity.colors ],\r\n\t\t\tmask: gameEntity.mask.split( '' ).map( m => m === '1' ),\r\n\t\t\truleSet: gameEntity.ruleSet,\r\n\t\t\tgameStates: gameStates.map( gs => ( {\r\n\t\t\t\tindex: gs.index,\r\n\t\t\t\tturn: gs.turn,\r\n\t\t\t\tdata: gs.data.map( v => ( v === 'x' ) ? null : parseInt( v, 10 ) ),\r\n\t\t\t\tlastMove: ( gs.lastMove.x == null || gs.lastMove.y == null ) ? null : { ...gs.lastMove }\r\n\t\t\t} ) )\r\n\t\t};\r\n\t}\r\n}\r\n","var id = 0;\nvar px = Math.random();\nmodule.exports = function (key) {\n  return 'Symbol('.concat(key === undefined ? '' : key, ')_', (++id + px).toString(36));\n};\n","var global = require('./_global');\nvar hide = require('./_hide');\nvar has = require('./_has');\nvar SRC = require('./_uid')('src');\nvar TO_STRING = 'toString';\nvar $toString = Function[TO_STRING];\nvar TPL = ('' + $toString).split(TO_STRING);\n\nrequire('./_core').inspectSource = function (it) {\n  return $toString.call(it);\n};\n\n(module.exports = function (O, key, val, safe) {\n  var isFunction = typeof val == 'function';\n  if (isFunction) has(val, 'name') || hide(val, 'name', key);\n  if (O[key] === val) return;\n  if (isFunction) has(val, SRC) || hide(val, SRC, O[key] ? '' + O[key] : TPL.join(String(key)));\n  if (O === global) {\n    O[key] = val;\n  } else if (!safe) {\n    delete O[key];\n    hide(O, key, val);\n  } else if (O[key]) {\n    O[key] = val;\n  } else {\n    hide(O, key, val);\n  }\n// add fake Function#toString for correct work wrapped methods / constructors with methods like LoDash isNative\n})(Function.prototype, TO_STRING, function toString() {\n  return typeof this == 'function' && this[SRC] || $toString.call(this);\n});\n","module.exports = function (it) {\n  return typeof it === 'object' ? it !== null : typeof it === 'function';\n};\n","var isObject = require('./_is-object');\nmodule.exports = function (it) {\n  if (!isObject(it)) throw TypeError(it + ' is not an object!');\n  return it;\n};\n","require('./_wks-define')('asyncIterator');\n","var def = require('./_object-dp').f;\nvar has = require('./_has');\nvar TAG = require('./_wks')('toStringTag');\n\nmodule.exports = function (it, tag, stat) {\n  if (it && !has(it = stat ? it : it.prototype, TAG)) def(it, TAG, { configurable: true, value: tag });\n};\n","// IE 8- don't enum bug keys\nmodule.exports = (\n  'constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf'\n).split(',');\n","// 7.1.4 ToInteger\nvar ceil = Math.ceil;\nvar floor = Math.floor;\nmodule.exports = function (it) {\n  return isNaN(it = +it) ? 0 : (it > 0 ? floor : ceil)(it);\n};\n","// 19.1.2.14 / 15.2.3.14 Object.keys(O)\nvar $keys = require('./_object-keys-internal');\nvar enumBugKeys = require('./_enum-bug-keys');\n\nmodule.exports = Object.keys || function keys(O) {\n  return $keys(O, enumBugKeys);\n};\n","var core = require('./_core');\nvar global = require('./_global');\nvar SHARED = '__core-js_shared__';\nvar store = global[SHARED] || (global[SHARED] = {});\n\n(module.exports = function (key, value) {\n  return store[key] || (store[key] = value !== undefined ? value : {});\n})('versions', []).push({\n  version: core.version,\n  mode: require('./_library') ? 'pure' : 'global',\n  copyright: ' 2018 Denis Pushkarev (zloirock.ru)'\n});\n","import { Entity, Column, PrimaryColumn, ManyToMany, ManyToOne, CreateDateColumn } from 'typeorm';\r\nimport { UserEntity } from './user.entity';\r\nimport { MetadataField } from 'server/metadata.field';\r\n\r\n@Entity( 'Session' )\r\nexport class SessionEntity {\r\n\t@PrimaryColumn( 'uuid' )\r\n\tpublic id: string;\r\n\r\n\t@Column( () => MetadataField )\r\n\tpublic meta: MetadataField;\r\n\r\n\t@Column()\r\n\tpublic nick: string;\r\n\r\n\t@ManyToOne( () => UserEntity, userEntity => userEntity.sessions )\r\n\tpublic user: UserEntity;\r\n\r\n\t@Column( 'uuid', { nullable: true } )\r\n\tpublic userId: string;\r\n}\r\n","import { Entity, Index, Column, PrimaryGeneratedColumn, OneToOne, CreateDateColumn } from 'typeorm';\r\nimport { UserEntity } from './user.entity';\r\nimport { MetadataField } from 'server/metadata.field';\r\n\r\n@Entity( 'Login' )\r\nexport class LoginEntity {\r\n\t@PrimaryGeneratedColumn( 'uuid' )\r\n\tpublic id: string;\r\n\r\n\t@Column( () => MetadataField )\r\n\tpublic meta: MetadataField;\r\n\r\n\t@Column()\r\n\t@Index( { unique: true } )\r\n\tpublic username: string;\r\n\r\n\t@Column()\r\n\tpublic passwordHash: string;\r\n\r\n\t@OneToOne( () => UserEntity, user => user.login )\r\n\tpublic user: UserEntity;\r\n\r\n\t@Column( 'uuid', { nullable: true } )\r\n\tpublic userId: string;\r\n}\r\n","import { Entity, Column, PrimaryGeneratedColumn, OneToOne, JoinColumn, JoinTable, CreateDateColumn } from 'typeorm';\r\nimport { GameEntity } from './game.entity';\r\nimport { MetadataField } from 'server/metadata.field';\r\n\r\n@Entity( 'Room' )\r\nexport class RoomEntity {\r\n\t@PrimaryGeneratedColumn( 'uuid' )\r\n\tpublic id: string;\r\n\r\n\t@Column( () => MetadataField )\r\n\tpublic meta: MetadataField;\r\n\r\n\t@Column()\r\n\tpublic name: string;\r\n\r\n\t@Column( { nullable: true } )\r\n\tpublic expires: Date;\r\n\r\n\t@Column()\r\n\tpublic password: string;\r\n\r\n\t@Column( 'uuid', { nullable: true} )\r\n\tpublic gameId: string;\r\n\r\n\t@OneToOne( () => GameEntity, { nullable: true } )\r\n\t@JoinColumn()\r\n\tpublic game: GameEntity;\r\n\r\n\tpublic static toRoom( roomEntity: RoomEntity ) {\r\n\t\treturn { roomId: roomEntity.id, gameId: roomEntity.gameId, name: roomEntity.name, hasPassword: !!roomEntity.password };\r\n\t}\r\n}\r\n","import { Entity, Column, PrimaryColumn, ManyToOne, CreateDateColumn } from 'typeorm';\r\nimport { GameEntity } from './game.entity';\r\nimport { PointFieldNull } from './point.field';\r\nimport { MetadataField } from './metadata.field';\r\n\r\n@Entity( 'GameState' )\r\nexport class GameStateEntity {\r\n\t@PrimaryColumn( 'uuid' )\r\n\tpublic gameId: string;\r\n\r\n\t@PrimaryColumn( { type: 'integer' } )\r\n\tpublic index: number;\r\n\r\n\t@Column( () => MetadataField )\r\n\tpublic meta: MetadataField;\r\n\r\n\t@ManyToOne( () => GameEntity, game => game.gameStates )\r\n\tpublic game: GameEntity;\r\n\r\n\t@Column( { type: 'integer', nullable: true } )\r\n\tpublic turn: number|null;\r\n\r\n\t@Column( () => PointFieldNull )\r\n\tpublic lastMove: PointFieldNull;\r\n\r\n\t@Column( { type: 'simple-array' } )\r\n\tpublic data: string[];\r\n}\r\n","// 7.2.1 RequireObjectCoercible(argument)\nmodule.exports = function (it) {\n  if (it == undefined) throw TypeError(\"Can't call method on  \" + it);\n  return it;\n};\n","// 7.1.13 ToObject(argument)\nvar defined = require('./_defined');\nmodule.exports = function (it) {\n  return Object(defined(it));\n};\n","module.exports = function (it) {\n  if (typeof it != 'function') throw TypeError(it + ' is not a function!');\n  return it;\n};\n","module.exports = function (bitmap, value) {\n  return {\n    enumerable: !(bitmap & 1),\n    configurable: !(bitmap & 2),\n    writable: !(bitmap & 4),\n    value: value\n  };\n};\n","var isObject = require('./_is-object');\nvar document = require('./_global').document;\n// typeof document.createElement is 'object' in old IE\nvar is = isObject(document) && isObject(document.createElement);\nmodule.exports = function (it) {\n  return is ? document.createElement(it) : {};\n};\n","var global = require('./_global');\nvar core = require('./_core');\nvar hide = require('./_hide');\nvar redefine = require('./_redefine');\nvar ctx = require('./_ctx');\nvar PROTOTYPE = 'prototype';\n\nvar $export = function (type, name, source) {\n  var IS_FORCED = type & $export.F;\n  var IS_GLOBAL = type & $export.G;\n  var IS_STATIC = type & $export.S;\n  var IS_PROTO = type & $export.P;\n  var IS_BIND = type & $export.B;\n  var target = IS_GLOBAL ? global : IS_STATIC ? global[name] || (global[name] = {}) : (global[name] || {})[PROTOTYPE];\n  var exports = IS_GLOBAL ? core : core[name] || (core[name] = {});\n  var expProto = exports[PROTOTYPE] || (exports[PROTOTYPE] = {});\n  var key, own, out, exp;\n  if (IS_GLOBAL) source = name;\n  for (key in source) {\n    // contains in native\n    own = !IS_FORCED && target && target[key] !== undefined;\n    // export native or passed\n    out = (own ? target : source)[key];\n    // bind timers to global for call from export context\n    exp = IS_BIND && own ? ctx(out, global) : IS_PROTO && typeof out == 'function' ? ctx(Function.call, out) : out;\n    // extend global\n    if (target) redefine(target, key, out, type & $export.U);\n    // export\n    if (exports[key] != out) hide(exports, key, exp);\n    if (IS_PROTO && expProto[key] != out) expProto[key] = out;\n  }\n};\nglobal.core = core;\n// type bitmap\n$export.F = 1;   // forced\n$export.G = 2;   // global\n$export.S = 4;   // static\n$export.P = 8;   // proto\n$export.B = 16;  // bind\n$export.W = 32;  // wrap\n$export.U = 64;  // safe\n$export.R = 128; // real proto method for `library`\nmodule.exports = $export;\n","import express from 'express';\r\nimport csp from 'express-csp';\r\nimport path from 'path';\r\nimport compression from 'compression';\r\nimport { appSettings, cspPolicy } from 'data/config.yaml';\r\n\r\nexport const app = express();\r\nfor( const [ key, value ] of Object.entries( appSettings ) ) {\r\n\tapp.set( key, value );\r\n}\r\napp.use( compression(), express.static( path.join( __dirname, 'www' ) ) );\r\ncsp.extend( app, cspPolicy );\r\napp.use( require( 'body-parser' ).json() );\r\napp.get( '/health', ( req, res ) => {\r\n\tres.writeHead( 200 );\r\n\tres.end();\r\n} );\r\n","import { Bounds } from 'src/bounds';\n\nexport class Square {\n\tpublic constructor(\n\t\tpublic readonly position: Point,\n\t\tpublic readonly bounds: Bounds\n\t) {}\n\n\tpublic enabled = true;\n\tpublic color: number|null = null;\n\n\tpublic get empty() { return this.color === null; }\n}\n","export class Bounds {\n\tpublic constructor(\n\t\tpublic readonly left: number,\n\t\tpublic readonly top: number,\n\t\tpublic readonly width: number,\n\t\tpublic readonly height: number\n\t) {}\n\n\tpublic get bottom() {\n\t\tconst { top, height } = this;\n\t\treturn top + height;\n\t}\n\n\tpublic get right() {\n\t\tconst { left, width } = this;\n\t\treturn left + width;\n\t}\n\n\tpublic get center() {\n\t\tconst { left, top, width, height } = this,\n\t\t\tx = left + width * .5,\n\t\t\ty = top + height * .5;\n\t\treturn { x, y };\n\t}\n\n\tpublic get n() {\n\t\tconst { left, top, width } = this,\n\t\t\tx = left + width * .5,\n\t\t\ty = top;\n\t\treturn { x, y };\n\t}\n\n\tpublic get ne() {\n\t\tconst { left, top, width } = this,\n\t\t\tx = left + width,\n\t\t\ty = top;\n\t\treturn { x, y };\n\t}\n\n\tpublic get e() {\n\t\tconst { left, top, width, height } = this,\n\t\t\tx = left + width,\n\t\t\ty = top + height * .5;\n\t\treturn { x, y };\n\t}\n\n\tpublic get se() {\n\t\tconst { left, top, width, height } = this,\n\t\t\tx = left + width,\n\t\t\ty = top + height;\n\t\treturn { x, y };\n\t}\n\n\tpublic get s() {\n\t\tconst { left, top, width, height } = this,\n\t\t\tx = left + width * .5,\n\t\t\ty = top + height;\n\t\treturn { x, y };\n\t}\n\n\tpublic get sw() {\n\t\tconst { left, top, height } = this,\n\t\t\tx = left,\n\t\t\ty = top + height;\n\t\treturn { x, y };\n\t}\n\n\tpublic get w() {\n\t\tconst { left, top, height } = this,\n\t\t\tx = left,\n\t\t\ty = top + height * .5;\n\t\treturn { x, y };\n\t}\n\n\tpublic get nw() {\n\t\tconst { left, top } = this,\n\t\t\tx = left,\n\t\t\ty = top;\n\t\treturn { x, y };\n\t}\n\n\tpublic hitTest( { x, y }: Point ) {\n\t\tconst { top, right, bottom, left } = this;\n\t\treturn x >= left && x <= right\n\t\t\t&& y >= top && y <= bottom;\n\t}\n}\n","function validate<T>( grid: Grid<T>, { x, y }: Point ) {\n\tif( !Number.isSafeInteger( x ) || !Number.isSafeInteger( y ) ) {\n\t\tthrow new Error( `(${x}, ${y}) is not valid` );\n\t}\n\tif( !grid.boundsCheck( { x, y } ) ) {\n\t\tthrow new Error( `(${x}, ${y}) is out of bounds` );\n\t}\n}\n\nexport class Grid<T> {\n\tpublic constructor( public readonly width: number, public readonly height: number ) {}\n\n\tpublic boundsCheck( { x, y }: Point ) {\n\t\tconst { width, height } = this;\n\t\treturn x >= 0 && x < width && y >= 0 && y < height;\n\t}\n\n\tpublic get( { x, y }: Point ) {\n\t\tvalidate( this, { x, y } );\n\t\tconst key = JSON.stringify( { x, y } );\n\t\treturn this.data.get( key );\n\t}\n\n\tpublic set( { x, y }: Point, value: T ) {\n\t\tvalidate( this, { x, y } );\n\t\tconst key = JSON.stringify( { x, y } );\n\t\tthis.data.set( key, value );\n\t}\n\n\tpublic [Symbol.iterator]() {\n\t\tfunction *iterator( this: Grid<T> ) {\n\t\t\tconst { width, height } = this;\n\t\t\tfor( let x = 0; x < width; ++x ) {\n\t\t\tfor( let y = 0; y < height; ++ y ) {\n\t\t\t\tyield this.get( { x, y } );\n\t\t\t} }\n\t\t}\n\t\treturn iterator.call( this ) as IterableIterator<T|undefined>;\n\t}\n\n\tprivate data = new Map<string, T>();\n}\n","exports.f = require('./_wks');\n","var global = require('./_global');\nvar core = require('./_core');\nvar LIBRARY = require('./_library');\nvar wksExt = require('./_wks-ext');\nvar defineProperty = require('./_object-dp').f;\nmodule.exports = function (name) {\n  var $Symbol = core.Symbol || (core.Symbol = LIBRARY ? {} : global.Symbol || {});\n  if (name.charAt(0) != '_' && !(name in $Symbol)) defineProperty($Symbol, name, { value: wksExt.f(name) });\n};\n","// 19.1.2.9 / 15.2.3.2 Object.getPrototypeOf(O)\nvar has = require('./_has');\nvar toObject = require('./_to-object');\nvar IE_PROTO = require('./_shared-key')('IE_PROTO');\nvar ObjectProto = Object.prototype;\n\nmodule.exports = Object.getPrototypeOf || function (O) {\n  O = toObject(O);\n  if (has(O, IE_PROTO)) return O[IE_PROTO];\n  if (typeof O.constructor == 'function' && O instanceof O.constructor) {\n    return O.constructor.prototype;\n  } return O instanceof Object ? ObjectProto : null;\n};\n","var document = require('./_global').document;\nmodule.exports = document && document.documentElement;\n","var toInteger = require('./_to-integer');\nvar max = Math.max;\nvar min = Math.min;\nmodule.exports = function (index, length) {\n  index = toInteger(index);\n  return index < 0 ? max(index + length, 0) : min(index, length);\n};\n","// 7.1.15 ToLength\nvar toInteger = require('./_to-integer');\nvar min = Math.min;\nmodule.exports = function (it) {\n  return it > 0 ? min(toInteger(it), 0x1fffffffffffff) : 0; // pow(2, 53) - 1 == 9007199254740991\n};\n","// false -> Array#indexOf\n// true  -> Array#includes\nvar toIObject = require('./_to-iobject');\nvar toLength = require('./_to-length');\nvar toAbsoluteIndex = require('./_to-absolute-index');\nmodule.exports = function (IS_INCLUDES) {\n  return function ($this, el, fromIndex) {\n    var O = toIObject($this);\n    var length = toLength(O.length);\n    var index = toAbsoluteIndex(fromIndex, length);\n    var value;\n    // Array#includes uses SameValueZero equality algorithm\n    // eslint-disable-next-line no-self-compare\n    if (IS_INCLUDES && el != el) while (length > index) {\n      value = O[index++];\n      // eslint-disable-next-line no-self-compare\n      if (value != value) return true;\n    // Array#indexOf ignores holes, Array#includes - not\n    } else for (;length > index; index++) if (IS_INCLUDES || index in O) {\n      if (O[index] === el) return IS_INCLUDES || index || 0;\n    } return !IS_INCLUDES && -1;\n  };\n};\n","var has = require('./_has');\nvar toIObject = require('./_to-iobject');\nvar arrayIndexOf = require('./_array-includes')(false);\nvar IE_PROTO = require('./_shared-key')('IE_PROTO');\n\nmodule.exports = function (object, names) {\n  var O = toIObject(object);\n  var i = 0;\n  var result = [];\n  var key;\n  for (key in O) if (key != IE_PROTO) has(O, key) && result.push(key);\n  // Don't enum bug & hidden keys\n  while (names.length > i) if (has(O, key = names[i++])) {\n    ~arrayIndexOf(result, key) || result.push(key);\n  }\n  return result;\n};\n","var dP = require('./_object-dp');\nvar anObject = require('./_an-object');\nvar getKeys = require('./_object-keys');\n\nmodule.exports = require('./_descriptors') ? Object.defineProperties : function defineProperties(O, Properties) {\n  anObject(O);\n  var keys = getKeys(Properties);\n  var length = keys.length;\n  var i = 0;\n  var P;\n  while (length > i) dP.f(O, P = keys[i++], Properties[P]);\n  return O;\n};\n","// 19.1.2.2 / 15.2.3.5 Object.create(O [, Properties])\nvar anObject = require('./_an-object');\nvar dPs = require('./_object-dps');\nvar enumBugKeys = require('./_enum-bug-keys');\nvar IE_PROTO = require('./_shared-key')('IE_PROTO');\nvar Empty = function () { /* empty */ };\nvar PROTOTYPE = 'prototype';\n\n// Create object with fake `null` prototype: use iframe Object with cleared prototype\nvar createDict = function () {\n  // Thrash, waste and sodomy: IE GC bug\n  var iframe = require('./_dom-create')('iframe');\n  var i = enumBugKeys.length;\n  var lt = '<';\n  var gt = '>';\n  var iframeDocument;\n  iframe.style.display = 'none';\n  require('./_html').appendChild(iframe);\n  iframe.src = 'javascript:'; // eslint-disable-line no-script-url\n  // createDict = iframe.contentWindow.Object;\n  // html.removeChild(iframe);\n  iframeDocument = iframe.contentWindow.document;\n  iframeDocument.open();\n  iframeDocument.write(lt + 'script' + gt + 'document.F=Object' + lt + '/script' + gt);\n  iframeDocument.close();\n  createDict = iframeDocument.F;\n  while (i--) delete createDict[PROTOTYPE][enumBugKeys[i]];\n  return createDict();\n};\n\nmodule.exports = Object.create || function create(O, Properties) {\n  var result;\n  if (O !== null) {\n    Empty[PROTOTYPE] = anObject(O);\n    result = new Empty();\n    Empty[PROTOTYPE] = null;\n    // add \"__proto__\" for Object.getPrototypeOf polyfill\n    result[IE_PROTO] = O;\n  } else result = createDict();\n  return Properties === undefined ? result : dPs(result, Properties);\n};\n","'use strict';\nvar create = require('./_object-create');\nvar descriptor = require('./_property-desc');\nvar setToStringTag = require('./_set-to-string-tag');\nvar IteratorPrototype = {};\n\n// 25.1.2.1.1 %IteratorPrototype%[@@iterator]()\nrequire('./_hide')(IteratorPrototype, require('./_wks')('iterator'), function () { return this; });\n\nmodule.exports = function (Constructor, NAME, next) {\n  Constructor.prototype = create(IteratorPrototype, { next: descriptor(1, next) });\n  setToStringTag(Constructor, NAME + ' Iterator');\n};\n","'use strict';\nvar LIBRARY = require('./_library');\nvar $export = require('./_export');\nvar redefine = require('./_redefine');\nvar hide = require('./_hide');\nvar Iterators = require('./_iterators');\nvar $iterCreate = require('./_iter-create');\nvar setToStringTag = require('./_set-to-string-tag');\nvar getPrototypeOf = require('./_object-gpo');\nvar ITERATOR = require('./_wks')('iterator');\nvar BUGGY = !([].keys && 'next' in [].keys()); // Safari has buggy iterators w/o `next`\nvar FF_ITERATOR = '@@iterator';\nvar KEYS = 'keys';\nvar VALUES = 'values';\n\nvar returnThis = function () { return this; };\n\nmodule.exports = function (Base, NAME, Constructor, next, DEFAULT, IS_SET, FORCED) {\n  $iterCreate(Constructor, NAME, next);\n  var getMethod = function (kind) {\n    if (!BUGGY && kind in proto) return proto[kind];\n    switch (kind) {\n      case KEYS: return function keys() { return new Constructor(this, kind); };\n      case VALUES: return function values() { return new Constructor(this, kind); };\n    } return function entries() { return new Constructor(this, kind); };\n  };\n  var TAG = NAME + ' Iterator';\n  var DEF_VALUES = DEFAULT == VALUES;\n  var VALUES_BUG = false;\n  var proto = Base.prototype;\n  var $native = proto[ITERATOR] || proto[FF_ITERATOR] || DEFAULT && proto[DEFAULT];\n  var $default = $native || getMethod(DEFAULT);\n  var $entries = DEFAULT ? !DEF_VALUES ? $default : getMethod('entries') : undefined;\n  var $anyNative = NAME == 'Array' ? proto.entries || $native : $native;\n  var methods, key, IteratorPrototype;\n  // Fix native\n  if ($anyNative) {\n    IteratorPrototype = getPrototypeOf($anyNative.call(new Base()));\n    if (IteratorPrototype !== Object.prototype && IteratorPrototype.next) {\n      // Set @@toStringTag to native iterators\n      setToStringTag(IteratorPrototype, TAG, true);\n      // fix for some old engines\n      if (!LIBRARY && typeof IteratorPrototype[ITERATOR] != 'function') hide(IteratorPrototype, ITERATOR, returnThis);\n    }\n  }\n  // fix Array#{values, @@iterator}.name in V8 / FF\n  if (DEF_VALUES && $native && $native.name !== VALUES) {\n    VALUES_BUG = true;\n    $default = function values() { return $native.call(this); };\n  }\n  // Define iterator\n  if ((!LIBRARY || FORCED) && (BUGGY || VALUES_BUG || !proto[ITERATOR])) {\n    hide(proto, ITERATOR, $default);\n  }\n  // Plug for library\n  Iterators[NAME] = $default;\n  Iterators[TAG] = returnThis;\n  if (DEFAULT) {\n    methods = {\n      values: DEF_VALUES ? $default : getMethod(VALUES),\n      keys: IS_SET ? $default : getMethod(KEYS),\n      entries: $entries\n    };\n    if (FORCED) for (key in methods) {\n      if (!(key in proto)) redefine(proto, key, methods[key]);\n    } else $export($export.P + $export.F * (BUGGY || VALUES_BUG), NAME, methods);\n  }\n  return methods;\n};\n","var toString = {}.toString;\n\nmodule.exports = function (it) {\n  return toString.call(it).slice(8, -1);\n};\n","// fallback for non-array-like ES3 and non-enumerable old V8 strings\nvar cof = require('./_cof');\n// eslint-disable-next-line no-prototype-builtins\nmodule.exports = Object('z').propertyIsEnumerable(0) ? Object : function (it) {\n  return cof(it) == 'String' ? it.split('') : Object(it);\n};\n","module.exports = function (done, value) {\n  return { value: value, done: !!done };\n};\n","// 22.1.3.31 Array.prototype[@@unscopables]\nvar UNSCOPABLES = require('./_wks')('unscopables');\nvar ArrayProto = Array.prototype;\nif (ArrayProto[UNSCOPABLES] == undefined) require('./_hide')(ArrayProto, UNSCOPABLES, {});\nmodule.exports = function (key) {\n  ArrayProto[UNSCOPABLES][key] = true;\n};\n","'use strict';\nvar addToUnscopables = require('./_add-to-unscopables');\nvar step = require('./_iter-step');\nvar Iterators = require('./_iterators');\nvar toIObject = require('./_to-iobject');\n\n// 22.1.3.4 Array.prototype.entries()\n// 22.1.3.13 Array.prototype.keys()\n// 22.1.3.29 Array.prototype.values()\n// 22.1.3.30 Array.prototype[@@iterator]()\nmodule.exports = require('./_iter-define')(Array, 'Array', function (iterated, kind) {\n  this._t = toIObject(iterated); // target\n  this._i = 0;                   // next index\n  this._k = kind;                // kind\n// 22.1.5.2.1 %ArrayIteratorPrototype%.next()\n}, function () {\n  var O = this._t;\n  var kind = this._k;\n  var index = this._i++;\n  if (!O || index >= O.length) {\n    this._t = undefined;\n    return step(1);\n  }\n  if (kind == 'keys') return step(0, index);\n  if (kind == 'values') return step(0, O[index]);\n  return step(0, [index, O[index]]);\n}, 'values');\n\n// argumentsList[@@iterator] is %ArrayProto_values% (9.4.4.6, 9.4.4.7)\nIterators.Arguments = Iterators.Array;\n\naddToUnscopables('keys');\naddToUnscopables('values');\naddToUnscopables('entries');\n","var $iterators = require('./es6.array.iterator');\nvar getKeys = require('./_object-keys');\nvar redefine = require('./_redefine');\nvar global = require('./_global');\nvar hide = require('./_hide');\nvar Iterators = require('./_iterators');\nvar wks = require('./_wks');\nvar ITERATOR = wks('iterator');\nvar TO_STRING_TAG = wks('toStringTag');\nvar ArrayValues = Iterators.Array;\n\nvar DOMIterables = {\n  CSSRuleList: true, // TODO: Not spec compliant, should be false.\n  CSSStyleDeclaration: false,\n  CSSValueList: false,\n  ClientRectList: false,\n  DOMRectList: false,\n  DOMStringList: false,\n  DOMTokenList: true,\n  DataTransferItemList: false,\n  FileList: false,\n  HTMLAllCollection: false,\n  HTMLCollection: false,\n  HTMLFormElement: false,\n  HTMLSelectElement: false,\n  MediaList: true, // TODO: Not spec compliant, should be false.\n  MimeTypeArray: false,\n  NamedNodeMap: false,\n  NodeList: true,\n  PaintRequestList: false,\n  Plugin: false,\n  PluginArray: false,\n  SVGLengthList: false,\n  SVGNumberList: false,\n  SVGPathSegList: false,\n  SVGPointList: false,\n  SVGStringList: false,\n  SVGTransformList: false,\n  SourceBufferList: false,\n  StyleSheetList: true, // TODO: Not spec compliant, should be false.\n  TextTrackCueList: false,\n  TextTrackList: false,\n  TouchList: false\n};\n\nfor (var collections = getKeys(DOMIterables), i = 0; i < collections.length; i++) {\n  var NAME = collections[i];\n  var explicit = DOMIterables[NAME];\n  var Collection = global[NAME];\n  var proto = Collection && Collection.prototype;\n  var key;\n  if (proto) {\n    if (!proto[ITERATOR]) hide(proto, ITERATOR, ArrayValues);\n    if (!proto[TO_STRING_TAG]) hide(proto, TO_STRING_TAG, NAME);\n    Iterators[NAME] = ArrayValues;\n    if (explicit) for (key in $iterators) if (!proto[key]) redefine(proto, key, $iterators[key], true);\n  }\n}\n","import { Grid } from 'src/grid';\nimport { Bounds } from 'src/bounds';\nimport { Square } from 'src/square';\nimport { zip } from 'lodash';\n\nexport class Board {\n\tpublic reset( { width, height }: Readonly<Size> ) {\n\t\tconst grid = new Grid<Square>( width, height ),\n\t\t\tsquareSize: Size = { width: 64, height: 64 },\n\t\t\tgutterSize: Size = { width: 6, height: 6 },\n\t\t\tbounds = new Bounds(\n\t\t\t\t0.5,\n\t\t\t\t0.5,\n\t\t\t\t1 + width * ( squareSize.width + gutterSize.width ) + gutterSize.width,\n\t\t\t\t1 + height * ( squareSize.height + gutterSize.height ) + gutterSize.height\n\t\t\t);\n\t\tfor( let x = 0; x < width; ++x ) {\n\t\tfor( let y = 0; y < height; ++y ) {\n\t\t\tconst position = { x, y },\n\t\t\t\tbounds = new Bounds(\n\t\t\t\t\t0.5 + x * ( squareSize.width + gutterSize.width ) + gutterSize.width,\n\t\t\t\t\t0.5 + y * ( squareSize.height + gutterSize.height ) + gutterSize.height,\n\t\t\t\t\t0.5 + squareSize.width,\n\t\t\t\t\t0.5 + squareSize.height\n\t\t\t\t);\n\t\t\tgrid.set( { x, y }, new Square( position, bounds ) );\n\t\t} }\n\t\tObject.assign( this, { grid, bounds } );\n\t}\n\n\tpublic get width() {\n\t\tconst { grid: { width } } = this;\n\t\treturn width;\n\t}\n\n\tpublic get height() {\n\t\tconst { grid: { height } } = this;\n\t\treturn height;\n\t}\n\n\tpublic get( { x, y }: Point ) {\n\t\tconst { grid } = this;\n\t\treturn grid.get( { x, y } )!;\n\t}\n\n\tpublic boundsCheck( { x, y }: Point ) {\n\t\tconst { grid } = this;\n\t\treturn grid.boundsCheck( { x, y } )!;\n\t}\n\n\tpublic getData() {\n\t\treturn Object.freeze( Array.from( this.grid ).map( sq => sq.empty ? null : sq.color ) );\n\t}\n\n\tpublic setData( data: ReadonlyArray<number> ) {\n\t\tfor( const [ color, square ] of zip( data, Array.from( this.grid ) ) ) {\n\t\t\tsquare.color = color;\n\t\t}\n\t}\n\n\tpublic getGameState( index: number ) {\n\t\treturn {\n\t\t\tindex,\n\n\t\t\tdata: this.getData()\n\t\t} as GameState;\n\t}\n\n\tpublic getMask() {\n\t\treturn Object.freeze( Array.from( this.grid ).map( sq => sq.enabled ) );\n\t}\n\n\tpublic setMask( mask: ReadonlyArray<boolean> ) {\n\t\tfor( const [ enabled, square ] of zip( mask, Array.from( this.grid ) ) ) {\n\t\t\tsquare.enabled = enabled;\n\t\t}\n\t}\n\n\tpublic static fromGame( game: Game, gameState: GameState ) {\n\t\tconst board = new Board;\n\t\tboard.reset( game.size );\n\t\tboard.setData( gameState.data );\n\t\tboard.setMask( game.mask );\n\t\treturn board;\n\t}\n\n\tpublic [Symbol.iterator]() {\n\t\tconst { grid } = this;\n\t\treturn grid[ Symbol.iterator ]() as IterableIterator<Square>;\n\t}\n\n\tpublic hitTest( pt: Point ): Square|null {\n\t\tfor( const square of this ) {\n\t\t\tif( square.bounds.hitTest( pt ) ) {\n\t\t\t\treturn square;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\n\tpublic bounds = new Bounds( 0, 0, 0, 0 );\n\tprivate grid = new Grid<Square>( 0, 0 );\n}\n","import { Board } from './board';\nimport { Square } from './square';\n\nconst directions: ReadonlyArray<Point> = [\n\t{ x:  0, y: -1 },\n\t{ x:  1, y: -1 },\n\t{ x:  1, y:  0 },\n\t{ x:  1, y:  1 },\n\t{ x:  0, y:  1 },\n\t{ x: -1, y:  1 },\n\t{ x: -1, y:  0 },\n\t{ x: -1, y: -1 }\n];\n\nfunction getAffectedSquares( board: Board, position: Point, color: number ): Square[] {\n\tif( !board.boundsCheck( position ) ) { return []; }\n\tconst square = board.get( position );\n\tif( !square || !square.empty || !square.enabled ) { return []; }\n\tfunction direction( { x, y }: Point, delta: Point ): Square[] {\n\t\tconst squares = [] as Square[];\n\t\tfor( ; ; ) {\n\t\t\tx += delta.x;\n\t\t\ty += delta.y;\n\t\t\tif( !board.boundsCheck( { x, y } ) ) { return []; }\n\t\t\tconst square = board.get( { x, y } );\n\t\t\tif( !square || square.empty || !square.enabled ) { return []; }\n\t\t\tif( square.color === color ) { return squares; }\n\t\t\tsquares.push( square );\n\t\t}\n\t}\n\tlet squares = [ square ];\n\tfor( const delta of directions ) {\n\t\tsquares = [ ...squares, ...direction( position, delta ) ];\n\t}\n\tif( squares.length <= 1 ) { return []; }\n\treturn squares;\n}\n\nclass RulesStandard implements Rules {\n\tpublic readonly name: string = 'Standard';\n\tpublic readonly ruleSet: RuleSet = RuleSet.standard;\n\tpublic readonly colors: number = 2;\n\tpublic readonly boardSize: Readonly<Size> = Object.freeze( { width: 8, height: 8 } );\n\n\tpublic isValid( game: Game, gameState: GameState, position: Point, color: number ) {\n\t\treturn getAffectedSquares( Board.fromGame( game, gameState ), position, color ).length > 0;\n\t}\n\n\tpublic compareScores( score1: number, score2: number ) {\n\t\treturn score1 - score2;\n\t}\n\n\tpublic getValidMoves( game: Game, gameState: GameState, color: number ) {\n\t\tconst points = [] as Point[];\n\t\tconst { size: { width, height } } = game;\n\t\tfor( let x = 0; x < width; ++x ) {\n\t\tfor( let y = 0; y < height; ++y ) {\n\t\t\tconst point = { x, y };\n\t\t\tif( this.isValid( game, gameState, point, color ) ) points.push( point );\n\t\t}\n\t\t}\n\t\treturn points;\n\t}\n\n\tpublic isGameOver( game: Game, gameState: GameState ) {\n\t\tconst { colors } = this;\n\t\tfor( let color = 0; color < colors; ++color ) {\n\t\t\tif( this.getValidMoves( game, gameState, color ).length > 0 ) return false;\n\t\t}\n\t\treturn true;\n\t}\n\n\tpublic makeMove( game: Game, gameState: GameState, position: Readonly<Point> ) {\n\t\tconst { turn: prevTurn, index: prevIndex } = gameState;\n\t\tconst board = Board.fromGame( game, gameState );\n\t\tconst squares = getAffectedSquares( board, position, prevTurn );\n\t\tif( squares.length === 0 ) return null;\n\t\tfor( const square of squares ) {\n\t\t\tsquare.color = prevTurn;\n\t\t}\n\t\tconst index = prevIndex + 1;\n\t\tconst lastMove = Object.freeze( { ...position } );\n\t\tconst data = board.getData();\n\t\tconst { colors } = this;\n\t\tlet turn: number|null = null;\n\t\tfor( let i = 0; i < colors; ++i ) {\n\t\t\tconst t = ( prevTurn + 1 + i ) % colors;\n\t\t\tif( this.getValidMoves( game, { turn: t, index, data, lastMove }, t ).length > 0 ) {\n\t\t\t\tturn = t;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn { turn, index, data, lastMove };\n\t}\n\n\tpublic getScore( game: Game, gameState: GameState, color: number ) {\n\t\tconst board = Board.fromGame( game, gameState );\n\t\tlet score = 0;\n\t\tfor( const square of board ) {\n\t\t\tif( square && square.enabled && square.color === color ) {\n\t\t\t\t++score;\n\t\t\t}\n\t\t}\n\t\treturn score;\n\t}\n\n\tpublic newGame( gameId: string ) {\n\t\tconst { boardSize } = this;\n\n\t\tconst board = new Board;\n\t\tboard.reset( boardSize );\n\t\t// TODO: center? gets ugly with an odd dimension\n\t\tboard.get( { x: 3, y: 3 } ).color = 0;\n\t\tboard.get( { x: 4, y: 3 } ).color = 1;\n\t\tboard.get( { x: 3, y: 4 } ).color = 1;\n\t\tboard.get( { x: 4, y: 4 } ).color = 0;\n\t\tconst gameStates = [ {\n\t\t\tturn: 0,\n\t\t\tindex: 0,\n\t\t\tdata: board.getData(),\n\t\t\tlastMove: null\n\t\t} as GameState ];\n\t\treturn {\n\t\t\tgameId,\n\t\t\truleSet: this.ruleSet,\n\t\t\tmask: board.getMask(),\n\t\t\tcolors: Object.freeze( [ 'black', 'white' ] ),\n\t\t\tsize: Object.freeze( { ...boardSize } ),\n\t\t\tgameStates: Object.freeze( gameStates )\n\t\t};\n\t}\n}\n\nclass RulesReversed extends RulesStandard {\n\tpublic readonly name: string = 'Reversed';\n\tpublic readonly ruleSet: RuleSet = RuleSet.reversed;\n\n\tpublic compareScores( score1: number, score2: number ) {\n\t\treturn score2 - score1;\n\t}\n}\n\nexport const rulesStandard = new RulesStandard;\nexport const rulesReversed = new RulesReversed;\nexport const ruleSets = [ rulesStandard, rulesReversed ] as Rules[];\nexport const ruleSetMap = new Map<RuleSet, Rules>();\nfor( const ruleSet of ruleSets ) {\n\truleSetMap.set( ruleSet.ruleSet, ruleSet );\n}\n","import { Column } from 'typeorm';\r\n\r\nexport class SizeField {\r\n\t@Column( { type: 'integer' } )\r\n\tpublic width: number;\r\n\r\n\t@Column( { type: 'integer' } )\r\n\tpublic height: number;\r\n}\r\n\r\nexport class SizeFieldNull {\r\n\t@Column( { type: 'integer', nullable: true } )\r\n\tpublic width: number;\r\n\r\n\t@Column( { type: 'integer', nullable: true } )\r\n\tpublic height: number;\r\n}\r\n","import { Column } from 'typeorm';\r\n\r\nexport class PointField {\r\n\t@Column( { type: 'integer' } )\r\n\tpublic x: number;\r\n\r\n\t@Column( { type: 'integer' } )\r\n\tpublic y: number;\r\n}\r\n\r\nexport class PointFieldNull {\r\n\t@Column( { type: 'integer', nullable: true } )\r\n\tpublic x: number;\r\n\r\n\t@Column( { type: 'integer', nullable: true } )\r\n\tpublic y: number;\r\n}\r\n","import { validation as config } from 'data/config.yaml';\r\n\r\nexport function isValidNick( nick: string ) {\r\n\tif( !nick ) return false;\r\n\tif( nick.length > config.maxNickLength ) return false;\r\n\treturn /^[_a-z][-_a-z0-9]+[_a-z0-9]+/i.test( nick );\r\n}\r\n\r\nexport function isValidRoomName( roomName: string ) {\r\n\tif( !roomName ) return false;\r\n\tif( roomName.length > config.maxRoomNameLength ) return false;\r\n\treturn true;\r\n}\r\n","import { fromEventPattern } from 'rxjs';\n\ntype EventTarget = NodeJS.EventEmitter;\n\nexport const fromNodeEvent = <T>( target: EventTarget, event: string ) =>\n\tfromEventPattern<T>(\n\t\te => { target.addListener( event, e as any ); },\n\t\te => { target.removeListener( event, e as any ); }\n\t);\n","'use strict';\nvar fails = require('./_fails');\n\nmodule.exports = function (method, arg) {\n  return !!method && fails(function () {\n    // eslint-disable-next-line no-useless-call\n    arg ? method.call(null, function () { /* empty */ }, 1) : method.call(null);\n  });\n};\n","// optional / simple context binding\nvar aFunction = require('./_a-function');\nmodule.exports = function (fn, that, length) {\n  aFunction(fn);\n  if (that === undefined) return fn;\n  switch (length) {\n    case 1: return function (a) {\n      return fn.call(that, a);\n    };\n    case 2: return function (a, b) {\n      return fn.call(that, a, b);\n    };\n    case 3: return function (a, b, c) {\n      return fn.call(that, a, b, c);\n    };\n  }\n  return function (/* ...args */) {\n    return fn.apply(that, arguments);\n  };\n};\n","// 7.1.1 ToPrimitive(input [, PreferredType])\nvar isObject = require('./_is-object');\n// instead of the ES6 spec version, we didn't implement @@toPrimitive case\n// and the second argument - flag - preferred type is a string\nmodule.exports = function (it, S) {\n  if (!isObject(it)) return it;\n  var fn, val;\n  if (S && typeof (fn = it.toString) == 'function' && !isObject(val = fn.call(it))) return val;\n  if (typeof (fn = it.valueOf) == 'function' && !isObject(val = fn.call(it))) return val;\n  if (!S && typeof (fn = it.toString) == 'function' && !isObject(val = fn.call(it))) return val;\n  throw TypeError(\"Can't convert object to primitive value\");\n};\n","module.exports = !require('./_descriptors') && !require('./_fails')(function () {\n  return Object.defineProperty(require('./_dom-create')('div'), 'a', { get: function () { return 7; } }).a != 7;\n});\n","'use strict';\nvar $export = require('./_export');\nvar aFunction = require('./_a-function');\nvar toObject = require('./_to-object');\nvar fails = require('./_fails');\nvar $sort = [].sort;\nvar test = [1, 2, 3];\n\n$export($export.P + $export.F * (fails(function () {\n  // IE8-\n  test.sort(undefined);\n}) || !fails(function () {\n  // V8 bug\n  test.sort(null);\n  // Old WebKit\n}) || !require('./_strict-method')($sort)), 'Array', {\n  // 22.1.3.25 Array.prototype.sort(comparefn)\n  sort: function sort(comparefn) {\n    return comparefn === undefined\n      ? $sort.call(toObject(this))\n      : $sort.call(toObject(this), aFunction(comparefn));\n  }\n});\n"],"sourceRoot":""}