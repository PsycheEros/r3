version: 2.0

jobs:
  configure_git:
    docker:
    - image: circleci/node:latest
    working_directory: ~/r3
    steps:
    - run: git config --global core.autocrlf false
    - run: git config --global credential.helper store
    - run: echo "https://${GITHUB_TOKEN}:x-oauth-basic@github.com" > ~\.git-credentials
    - run: git config --global user.name "CircleCI"
    - run: git config --global user.email "error@error-unlimited.net"
  checkout_code:
    docker:
    - image: circleci/node:latest
    working_directory: ~/r3
    steps:
    - checkout
    - save_cache:
        key: v1-repo-{{ .Environment.CIRCLE_SHA1 }}
        paths:
        - ~/r3
  build:
    docker:
    - image: circleci/node:latest
    environment:
      YARN_CACHE_FOLDER: .yarn
    working_directory: r3
    steps:
    - checkout
    - restore_cache:
        keys:
        - v1-dependencies-{{ checksum "yarn.lock" }}
        - v1-dependencies-
    - run: yarn install --non-interactive --frozen-lockfile --production=false
    - save_cache:
        paths:
        - node_modules
        - {{ .Environment.YARN_CACHE_FOLDER }}
        key: v1-dependencies-{{ checksum "yarn.lock" }}
    - run: yarn build
  deploy:
    docker:
    - image: circleci/node:latest
    working_directory: ~/r3
    steps:
    - run: yarn deploy
workflows:
  version: 2
  build-and-deploy:
    jobs:
    - configure_git
    - checkout_code:
        requires:
        - configure_git
    - build:
        requires:
        - checkout_code
    - deploy:
        requires:
        - build
